{% extends "base.html" %}

{% block title %}上傳音訊 - 會議助手{% endblock %}
{% block page_title %}上傳會議音訊{% endblock %}

{% block page_actions %}
<a href="{{ url_for('meetings_list') }}" class="btn btn-info btn-sm">
    <i class="fa fa-list"></i> 查看會議記錄
</a>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12 col-sm-12">
        <div class="x_panel">
            <div class="x_title">
                <h2><i class="fa fa-upload"></i> 上傳會議音訊檔案</h2>
                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                <!-- 支援的格式說明 -->
                <div class="alert alert-info">
                    <h4><i class="fa fa-info-circle"></i> 支援的音訊格式</h4>
                    <p>支援 M4A、MP3、WAV、FLAC、WebM 格式，檔案大小限制 500MB</p>
                    <p><strong>處理流程：</strong> 語音轉文字 → 語者辨識 → 生成帶語者標註的字幕</p>
                </div>

                <!-- 上傳表單 -->
                <form id="uploadForm" action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-8">
                            <!-- 拖放上傳區域 -->
                            <div class="upload-area" id="uploadArea">
                                <div class="upload-content">
                                    <i class="fa fa-cloud-upload fa-3x" style="color: #34495e; margin-bottom: 15px;"></i>
                                    <h4>拖放音訊檔案到此處</h4>
                                    <p>或者</p>
                                    <input type="file" id="fileInput" name="file" accept=".m4a,.mp3,.wav,.flac,.webm" style="display: none;">
                                    <button type="button" class="btn btn-primary btn-lg" onclick="document.getElementById('fileInput').click();">
                                        <i class="fa fa-folder-open"></i> 選擇檔案
                                    </button>
                                </div>
                                
                                <!-- 檔案資訊顯示區域 -->
                                <div id="fileInfo" class="file-info" style="display: none;">
                                    <h5><i class="fa fa-file-audio-o"></i> 選中的檔案</h5>
                                    <p id="fileName"></p>
                                    <p id="fileSize"></p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <!-- 進階設定 -->
                            <div class="x_panel">
                                <div class="x_title">
                                    <h2><i class="fa fa-cogs"></i> 進階設定</h2>
                                    <div class="clearfix"></div>
                                </div>
                                <div class="x_content">
                                    <div class="form-group">
                                        <label for="numSpeakers">預期語者數量（可選）</label>
                                        <input type="number" class="form-control" id="numSpeakers" name="num_speakers" 
                                               min="1" max="10" placeholder="系統自動偵測">
                                        <small class="help-block">
                                            如果您知道會議中的發言人數量，輸入此資訊可以提高語者辨識的準確度
                                        </small>
                                    </div>
                                    
                                    <div class="form-group">
                                        <div class="checkbox">
                                            <label>
                                                <input type="checkbox" id="autoProcess" checked> 上傳後自動開始處理
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 處理說明 -->
                            <div class="x_panel">
                                <div class="x_title">
                                    <h2><i class="fa fa-question-circle"></i> 處理說明</h2>
                                    <div class="clearfix"></div>
                                </div>
                                <div class="x_content">
                                    <div class="timeline">
                                        <div class="timeline-item">
                                            <div class="timeline-marker"></div>
                                            <div class="timeline-content">
                                                <h6>1. 音訊預處理</h6>
                                                <p>格式轉換與壓縮優化</p>
                                            </div>
                                        </div>
                                        <div class="timeline-item">
                                            <div class="timeline-marker"></div>
                                            <div class="timeline-content">
                                                <h6>2. 語音轉文字</h6>
                                                <p>使用 Whisper AI 進行轉錄</p>
                                            </div>
                                        </div>
                                        <div class="timeline-item">
                                            <div class="timeline-marker"></div>
                                            <div class="timeline-content">
                                                <h6>3. 語者辨識</h6>
                                                <p>識別不同發言者的時間段</p>
                                            </div>
                                        </div>
                                        <div class="timeline-item">
                                            <div class="timeline-marker"></div>
                                            <div class="timeline-content">
                                                <h6>4. 結果合併</h6>
                                                <p>生成帶語者標註的字幕</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 上傳按鈕 -->
                    <div class="row">
                        <div class="col-md-12 text-center">
                            <button type="submit" class="btn btn-success btn-lg" id="uploadBtn" disabled>
                                <i class="fa fa-upload"></i> 開始上傳並處理
                            </button>
                        </div>
                    </div>
                </form>

                <!-- 上傳進度條 -->
                <div id="uploadProgress" class="progress-container" style="display: none;">
                    <h4>檔案上傳中...</h4>
                    <div class="progress progress-striped active">
                        <div class="progress-bar progress-bar-success" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 最近的處理記錄 -->
<div class="row">
    <div class="col-md-12">
        <div class="x_panel">
            <div class="x_title">
                <h2><i class="fa fa-clock-o"></i> 最近的處理記錄</h2>
                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                <div id="recentMeetings">
                    <p class="text-center text-muted">載入中...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .timeline {
        position: relative;
        padding-left: 30px;
    }
    
    .timeline::before {
        content: '';
        position: absolute;
        left: 15px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #3498db;
    }
    
    .timeline-item {
        position: relative;
        margin-bottom: 20px;
    }
    
    .timeline-marker {
        position: absolute;
        left: -23px;
        top: 5px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #3498db;
        border: 3px solid #fff;
        box-shadow: 0 0 0 2px #3498db;
    }
    
    .timeline-content h6 {
        margin: 0 0 5px 0;
        font-weight: bold;
        color: #2c3e50;
    }
    
    .timeline-content p {
        margin: 0;
        color: #7f8c8d;
        font-size: 13px;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    
    // 拖放功能
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            handleFileSelection(files[0]);
        }
    });
    
    // 檔案選擇處理
    fileInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            handleFileSelection(e.target.files[0]);
        }
    });
    
    function handleFileSelection(file) {
        // 檢查檔案類型
        const allowedTypes = ['audio/m4a', 'audio/mp3', 'audio/mpeg', 'audio/wav', 'audio/flac', 'audio/webm'];
        const allowedExtensions = ['.m4a', '.mp3', '.wav', '.flac', '.webm'];
        
        const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
        
        if (!allowedExtensions.includes(fileExtension)) {
            alert('不支援的檔案格式！請選擇 M4A、MP3、WAV、FLAC 或 WebM 格式的檔案。');
            return;
        }
        
        // 檢查檔案大小 (500MB 限制)
        if (file.size > 500 * 1024 * 1024) {
            alert('檔案太大！請選擇小於 500MB 的檔案。');
            return;
        }
        
        // 顯示檔案資訊
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        fileInfo.style.display = 'block';
        uploadBtn.disabled = false;
    }
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // 表單提交處理
    $('#uploadForm').on('submit', function(e) {
        e.preventDefault();
        
        if (!fileInput.files[0]) {
            alert('請先選擇要上傳的檔案！');
            return;
        }
        
        // 顯示上傳進度
        $('#uploadProgress').show();
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 上傳中...';
        
        // 使用 FormData 進行檔案上傳
        const formData = new FormData(this);
        
        $.ajax({
            url: $(this).attr('action'),
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            xhr: function() {
                const xhr = new window.XMLHttpRequest();
                xhr.upload.addEventListener('progress', function(e) {
                    if (e.lengthComputable) {
                        const percentComplete = (e.loaded / e.total) * 100;
                        $('.progress-bar').css('width', percentComplete + '%');
                    }
                });
                return xhr;
            },
            success: function(response) {
                // 上傳成功，重定向到結果頁面
                window.location.href = response.redirect || '/meetings';
            },
            error: function() {
                alert('上傳失敗，請重試！');
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = '<i class="fa fa-upload"></i> 開始上傳並處理';
                $('#uploadProgress').hide();
            }
        });
    });
    
    // 載入最近的會議記錄
    loadRecentMeetings();
    
    function loadRecentMeetings() {
        $.get('/meetings', function(data) {
            // 這裡簡化處理，實際應該有專門的 API 端點
            // 暫時顯示一個連結
            $('#recentMeetings').html(
                '<p><a href="/meetings" class="btn btn-info">查看所有會議記錄 <i class="fa fa-arrow-right"></i></a></p>'
            );
        });
    }
});
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}ä¸Šå‚³éŸ³è¨Š - æœƒè­°åŠ©æ‰‹{% endblock %}
{% block page_title %}ä¸Šå‚³æœƒè­°éŸ³è¨Š{% endblock %}

{% block page_actions %}
<a href="{{ url_for('meetings_list') }}" class="btn btn-info btn-sm">
    <i class="fa fa-list"></i> æŸ¥çœ‹æœƒè­°è¨˜éŒ„
</a>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 col-sm-12">
        <div class="x_panel fade-in">
            <div class="x_title">
                <h2><i class="fa fa-cloud-upload"></i> ä¸Šå‚³æœƒè­°éŸ³è¨Šæª”æ¡ˆ</h2>
                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                <!-- æ”¯æ´çš„æ ¼å¼èªªæ˜ -->
                <div class="alert alert-info">
                    <h4><i class="fa fa-info-circle"></i> æ”¯æ´çš„éŸ³è¨Šæ ¼å¼èˆ‡è™•ç†æµç¨‹</h4>
                    <p><strong>æª”æ¡ˆæ ¼å¼ï¼š</strong>æ”¯æ´ M4Aã€MP3ã€WAVã€FLACã€WebM æ ¼å¼ï¼Œæª”æ¡ˆå¤§å°é™åˆ¶ 500MB</p>
                    <p><strong>AI è™•ç†ï¼š</strong>èªéŸ³è½‰æ–‡å­— â†’ èªè€…è¾¨è­˜ â†’ ç”Ÿæˆå¸¶èªè€…æ¨™è¨»çš„å­—å¹• â†’ æœƒè­°æ‘˜è¦èˆ‡è¡Œå‹•é …ç›®</p>
                </div>

                <!-- ä¸Šå‚³è¡¨å–® -->
                <form id="uploadForm" action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data">
                    <!-- æ‹–æ”¾ä¸Šå‚³å€åŸŸ -->
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-content">
                            <i class="fa fa-cloud-upload-alt"></i>
                            <h4 style="margin: 1rem 0 0.5rem 0; color: var(--text-primary); font-weight: 600;">æ‹–æ”¾éŸ³è¨Šæª”æ¡ˆåˆ°æ­¤è™•</h4>
                            <p style="color: var(--text-secondary); margin-bottom: 2rem;">æˆ–é»æ“Šä¸‹æ–¹æŒ‰éˆ•é¸æ“‡æª”æ¡ˆ</p>
                            <input type="file" id="fileInput" name="file" accept=".m4a,.mp3,.wav,.flac,.webm" style="display: none;">
                            <button type="button" class="btn btn-primary btn-lg" onclick="document.getElementById('fileInput').click();">
                                <i class="fa fa-folder-open"></i> é¸æ“‡æª”æ¡ˆ
                            </button>
                        </div>
                        
                        <!-- æª”æ¡ˆè³‡è¨Šé¡¯ç¤ºå€åŸŸ -->
                        <div id="fileInfo" class="file-info" style="display: none;">
                            <h5><i class="fa fa-file-audio"></i> é¸ä¸­çš„æª”æ¡ˆ</h5>
                            <p id="fileName" style="margin: 0.5rem 0; font-weight: 600;"></p>
                            <p id="fileSize" style="margin: 0.5rem 0; color: var(--text-secondary);"></p>
                            <button type="submit" class="btn btn-success" style="margin-top: 1rem;">
                                <i class="fa fa-upload"></i> é–‹å§‹ä¸Šå‚³ä¸¦è™•ç†
                            </button>
                        </div>
                    </div>
                </form>

                <!-- ä¸Šå‚³é€²åº¦æ¢ -->
                <div id="uploadProgress" class="progress-container" style="display: none;">
                    <h4><i class="fa fa-spinner fa-spin"></i> æª”æ¡ˆè™•ç†ä¸­...</h4>
                    <div class="progress progress-striped active">
                        <div class="progress-bar progress-bar-success" id="progressBar" style="width: 0%"></div>
                    </div>
                    <p style="text-align: center; margin-top: 1rem; color: var(--text-secondary);" id="progressText">æº–å‚™ä¸­...</p>
                    
                    <!-- è™•ç†æ­¥é©ŸæŒ‡ç¤ºå™¨ -->
                    <div class="processing-steps" id="processingSteps" style="margin-top: 2rem;">
                        <div class="step completed" id="step1">
                            <i class="fa fa-check"></i> æª”æ¡ˆä¸Šå‚³å®Œæˆ
                        </div>
                        <div class="step active" id="step2">
                            <i class="fa fa-cog fa-spin"></i> éŸ³è¨Šé è™•ç†ä¸­
                        </div>
                        <div class="step" id="step3">
                            <i class="fa fa-circle-o"></i> èªéŸ³è½‰æ–‡å­—
                        </div>
                        <div class="step" id="step4">
                            <i class="fa fa-circle-o"></i> èªè€…è¾¨è­˜
                        </div>
                        <div class="step" id="step5">
                            <i class="fa fa-circle-o"></i> ç”Ÿæˆçµæœ
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4 col-sm-12">
        <!-- é€²éšè¨­å®š -->
        <div class="x_panel fade-in">
            <div class="x_title">
                <h2><i class="fa fa-cogs"></i> é€²éšè¨­å®š</h2>
                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                <div class="form-group">
                    <label for="numSpeakers">é æœŸèªè€…æ•¸é‡ï¼ˆå¯é¸ï¼‰</label>
                    <input type="number" class="form-control" id="numSpeakers" name="num_speakers" 
                           min="1" max="10" placeholder="ç³»çµ±è‡ªå‹•åµæ¸¬" form="uploadForm"
                           style="border-radius: var(--radius-md); border: 1px solid var(--border-color); padding: 0.75rem;">
                    <small class="help-block" style="color: var(--text-secondary);">
                        å¦‚æœæ‚¨çŸ¥é“æœƒè­°ä¸­çš„ç™¼è¨€äººæ•¸é‡ï¼Œè¼¸å…¥æ­¤è³‡è¨Šå¯ä»¥æé«˜èªè€…è¾¨è­˜çš„æº–ç¢ºåº¦
                    </small>
                </div>
                
                <div class="form-group">
                    <div class="checkbox">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="autoProcess" checked form="uploadForm"> 
                            <span>ä¸Šå‚³å¾Œè‡ªå‹•é–‹å§‹è™•ç†</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label>éŸ³è¨Šå“è³ªå»ºè­°</label>
                    <div style="background: var(--bg-secondary); padding: 1rem; border-radius: var(--radius-md); margin-top: 0.5rem;">
                        <small style="color: var(--text-secondary); line-height: 1.6;">
                            â€¢ å»ºè­°ä½¿ç”¨æ¸…æ™°çš„éŒ„éŸ³è¨­å‚™<br>
                            â€¢ é¿å…èƒŒæ™¯å™ªéŸ³å¹²æ“¾<br>
                            â€¢ ç¢ºä¿æ‰€æœ‰ç™¼è¨€è€…éŸ³é‡é©ä¸­<br>
                            â€¢ å»ºè­°éŸ³è¨Šé•·åº¦ä¸è¶…é 2 å°æ™‚
                        </small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- è™•ç†èªªæ˜ -->
        <div class="x_panel fade-in">
            <div class="x_title">
                <h2><i class="fa fa-question-circle"></i> AI è™•ç†æµç¨‹</h2>
                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-marker" style="background: var(--info-color);"></div>
                        <div class="timeline-content">
                            <h6 style="color: var(--text-primary); font-weight: 600;">1. éŸ³è¨Šé è™•ç†</h6>
                            <p style="color: var(--text-secondary); font-size: 0.9rem;">æ ¼å¼è½‰æ›èˆ‡éŸ³è³ªå„ªåŒ–</p>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-marker" style="background: var(--primary-color);"></div>
                        <div class="timeline-content">
                            <h6 style="color: var(--text-primary); font-weight: 600;">2. èªéŸ³è½‰æ–‡å­—</h6>
                            <p style="color: var(--text-secondary); font-size: 0.9rem;">ä½¿ç”¨ OpenAI Whisper AI é€²è¡Œè½‰éŒ„</p>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-marker" style="background: var(--secondary-color);"></div>
                        <div class="timeline-content">
                            <h6 style="color: var(--text-primary); font-weight: 600;">3. èªè€…è¾¨è­˜</h6>
                            <p style="color: var(--text-secondary); font-size: 0.9rem;">æ™ºæ…§è­˜åˆ¥ä¸åŒç™¼è¨€è€…</p>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-marker" style="background: var(--accent-color);"></div>
                        <div class="timeline-content">
                            <h6 style="color: var(--text-primary); font-weight: 600;">4. æ™ºæ…§åˆ†æ</h6>
                            <p style="color: var(--text-secondary); font-size: 0.9rem;">ç”Ÿæˆæ‘˜è¦èˆ‡è¡Œå‹•é …ç›®</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æœ€è¿‘çš„è™•ç†è¨˜éŒ„ -->
<div class="row">
    <div class="col-md-12">
        <div class="x_panel fade-in">
            <div class="x_title">
                <h2><i class="fa fa-clock-o"></i> æœ€è¿‘çš„è™•ç†è¨˜éŒ„</h2>
                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                <div id="recentMeetings">
                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        <i class="fa fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem; color: var(--primary-color);"></i>
                        <p>è¼‰å…¥æœ€è¿‘çš„æœƒè­°è¨˜éŒ„...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .timeline {
        position: relative;
        padding-left: 30px;
    }
    
    .timeline::before {
        content: '';
        position: absolute;
        left: 15px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: linear-gradient(to bottom, var(--info-color), var(--accent-color));
        opacity: 0.3;
    }
    
    .timeline-item {
        position: relative;
        margin-bottom: 20px;
    }
    
    .timeline-marker {
        position: absolute;
        left: -23px;
        top: 5px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 3px solid #fff;
        box-shadow: 0 0 0 2px var(--border-color);
    }
    
    .timeline-content h6 {
        margin: 0 0 5px 0;
        font-weight: bold;
    }
    
    .timeline-content p {
        margin: 0;
        font-size: 13px;
    }
    
    /* è‡ªå®šç¾©è¡¨å–®æ¨£å¼ */
    .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const uploadProgress = document.getElementById('uploadProgress');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    
    // æ‹–æ”¾åŠŸèƒ½
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            handleFileSelection(files[0]);
        }
    });
    
    // æª”æ¡ˆé¸æ“‡è™•ç†
    fileInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            handleFileSelection(e.target.files[0]);
        }
    });
    
    function handleFileSelection(file) {
        // æª¢æŸ¥æª”æ¡ˆé¡å‹
        const allowedTypes = ['audio/m4a', 'audio/mp3', 'audio/mpeg', 'audio/wav', 'audio/flac', 'audio/webm'];
        const allowedExtensions = ['.m4a', '.mp3', '.wav', '.flac', '.webm'];
        
        const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
        
        if (!allowedExtensions.includes(fileExtension)) {
            showAlert('ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼ï¼è«‹é¸æ“‡ M4Aã€MP3ã€WAVã€FLAC æˆ– WebM æ ¼å¼çš„æª”æ¡ˆã€‚', 'danger');
            return;
        }
        
        // æª¢æŸ¥æª”æ¡ˆå¤§å° (500MB é™åˆ¶)
        if (file.size > 500 * 1024 * 1024) {
            showAlert('æª”æ¡ˆå¤ªå¤§ï¼è«‹é¸æ“‡å°æ–¼ 500MB çš„æª”æ¡ˆã€‚', 'danger');
            return;
        }
        
        // é¡¯ç¤ºæª”æ¡ˆè³‡è¨Š
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        fileInfo.style.display = 'block';
        
        // æ·»åŠ å‹•ç•«æ•ˆæœ
        setTimeout(() => {
            fileInfo.classList.add('fade-in');
        }, 100);
    }
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // è¡¨å–®æäº¤è™•ç†
    $('#uploadForm').on('submit', function(e) {
        e.preventDefault();
        
        if (!fileInput.files[0]) {
            showAlert('è«‹å…ˆé¸æ“‡è¦ä¸Šå‚³çš„æª”æ¡ˆï¼', 'warning');
            return;
        }
        
        startUploadProcess();
    });
    
    function startUploadProcess() {
        // éš±è—ä¸Šå‚³å€åŸŸï¼Œé¡¯ç¤ºé€²åº¦
        uploadArea.style.display = 'none';
        uploadProgress.style.display = 'block';
        
        // æ¨¡æ“¬ä¸Šå‚³å’Œè™•ç†é€²åº¦
        simulateProgress();
        
        // å¯¦éš›çš„è¡¨å–®æäº¤ï¼ˆå¯ä»¥åœ¨é€™è£¡ä½¿ç”¨ AJAXï¼‰
        const formData = new FormData(document.getElementById('uploadForm'));
        
        $.ajax({
            url: $('#uploadForm').attr('action'),
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                // è™•ç†æˆåŠŸå›æ‡‰
                console.log('Upload successful');
            },
            error: function(xhr, status, error) {
                showAlert('ä¸Šå‚³å¤±æ•—ï¼š' + error, 'danger');
                // é‡ç½®ä»‹é¢
                resetUploadInterface();
            }
        });
    }
    
    function simulateProgress() {
        let progress = 0;
        const steps = [
            { text: 'æª”æ¡ˆä¸Šå‚³ä¸­...', step: 1 },
            { text: 'éŸ³è¨Šé è™•ç†ä¸­...', step: 2 },
            { text: 'èªéŸ³è½‰æ–‡å­—ä¸­...', step: 3 },
            { text: 'èªè€…è¾¨è­˜ä¸­...', step: 4 },
            { text: 'ç”Ÿæˆçµæœä¸­...', step: 5 }
        ];
        
        const interval = setInterval(() => {
            progress += Math.random() * 8 + 2; // éš¨æ©Ÿå¢åŠ  2-10%
            if (progress > 100) progress = 100;
            
            progressBar.style.width = progress + '%';
            
            // æ›´æ–°æ­¥é©Ÿç‹€æ…‹
            const currentStep = Math.floor(progress / 20) + 1;
            updateProcessingSteps(currentStep, steps);
            
            if (currentStep <= steps.length) {
                progressText.textContent = steps[currentStep - 1].text;
            }
            
            if (progress >= 100) {
                clearInterval(interval);
                progressText.textContent = 'âœ… è™•ç†å®Œæˆï¼æ­£åœ¨è·³è½‰...';
                
                setTimeout(() => {
                    showAlert('ğŸ‰ æª”æ¡ˆè™•ç†å®Œæˆï¼å³å°‡è·³è½‰åˆ°çµæœé é¢...', 'success');
                    // é€™è£¡å¯ä»¥è·³è½‰åˆ°çµæœé é¢
                    // window.location.href = '/meetings';
                }, 1000);
            }
        }, 300);
    }
    
    function updateProcessingSteps(currentStep, steps) {
        for (let i = 1; i <= 5; i++) {
            const stepElement = document.getElementById(`step${i}`);
            const icon = stepElement.querySelector('i');
            
            if (i < currentStep) {
                // å·²å®Œæˆçš„æ­¥é©Ÿ
                stepElement.className = 'step completed';
                icon.className = 'fa fa-check';
            } else if (i === currentStep) {
                // ç•¶å‰æ­¥é©Ÿ
                stepElement.className = 'step active';
                icon.className = 'fa fa-cog fa-spin';
            } else {
                // æœªé–‹å§‹çš„æ­¥é©Ÿ
                stepElement.className = 'step';
                icon.className = 'fa fa-circle-o';
            }
        }
    }
    
    function showAlert(message, type) {
        const alertHtml = `
            <div class="alert alert-${type} alert-dismissible fade in" role="alert" style="margin-top: 1rem;">
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">Ã—</span>
                </button>
                ${message}
            </div>
        `;
        
        // åœ¨ä¸Šå‚³å€åŸŸå‰æ’å…¥æé†’
        $(alertHtml).insertBefore('#uploadArea');
        
        // è‡ªå‹•é—œé–‰
        setTimeout(() => {
            $('.alert').fadeOut();
        }, 5000);
    }
    
    function resetUploadInterface() {
        uploadArea.style.display = 'block';
        uploadProgress.style.display = 'none';
        fileInfo.style.display = 'none';
        progressBar.style.width = '0%';
    }
    
    // è¼‰å…¥æœ€è¿‘çš„æœƒè­°è¨˜éŒ„
    loadRecentMeetings();
    
    function loadRecentMeetings() {
        // æ¨¡æ“¬è¼‰å…¥å»¶é²
        setTimeout(() => {
            $('#recentMeetings').html(`
                <div style="text-align: center; padding: 2rem;">
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">å°šç„¡æœƒè­°è¨˜éŒ„</p>
                    <a href="${'{{ url_for("meetings_list") }}'}" class="btn btn-info">
                        <i class="fa fa-arrow-right"></i> æŸ¥çœ‹æ‰€æœ‰æœƒè­°è¨˜éŒ„
                    </a>
                </div>
            `);
        }, 1500);
    }
    
    // é é¢è¼‰å…¥å‹•ç•«
    const elements = document.querySelectorAll('.fade-in');
    elements.forEach((el, index) => {
        el.style.animationDelay = `${index * 0.1}s`;
    });
});
</script>
{% endblock %}
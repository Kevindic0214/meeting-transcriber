{% extends "base.html" %}

{% block title %}上傳音訊 - 會議助手{% endblock %}
{% block page_title %}上傳會議音訊{% endblock %}

{% block page_actions %}
<a href="{{ url_for('meetings_list') }}" class="btn btn-info btn-sm">
    <i class="fa fa-list"></i> 查看會議記錄
</a>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 col-sm-12">
        <div class="x_panel fade-in">
            <div class="x_title">
                <h2><i class="fa fa-cloud-upload"></i> 上傳會議音訊檔案</h2>
                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                <!-- 支援的格式說明 -->
                <div class="alert alert-info">
                    <h4><i class="fa fa-info-circle"></i> 支援的音訊格式與處理流程</h4>
                    <p><strong>檔案格式：</strong>支援 M4A、MP3、WAV、FLAC、WebM 格式，檔案大小限制 500MB</p>
                    <p><strong>AI 處理：</strong>語音轉文字 → 語者辨識 → 生成帶語者標註的字幕 → 會議摘要與行動項目</p>
                </div>

                <!-- 上傳表單 -->
                <form id="uploadForm" action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data">
                    <!-- 拖放上傳區域 -->
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-content">
                            <i class="fa fa-cloud-upload-alt"></i>
                            <h4 style="margin: 1rem 0 0.5rem 0; color: var(--text-primary); font-weight: 600;">拖放音訊檔案到此處</h4>
                            <p style="color: var(--text-secondary); margin-bottom: 2rem;">或點擊下方按鈕選擇檔案</p>
                            <input type="file" id="fileInput" name="file" accept=".m4a,.mp3,.wav,.flac,.webm" style="display: none;">
                            <button type="button" class="btn btn-primary btn-lg" onclick="document.getElementById('fileInput').click();">
                                <i class="fa fa-folder-open"></i> 選擇檔案
                            </button>
                        </div>
                        
                        <!-- 檔案資訊顯示區域 -->
                        <div id="fileInfo" class="file-info" style="display: none;">
                            <h5><i class="fa fa-file-audio"></i> 選中的檔案</h5>
                            <p id="fileName" style="margin: 0.5rem 0; font-weight: 600;"></p>
                            <p id="fileSize" style="margin: 0.5rem 0; color: var(--text-secondary);"></p>
                            <button type="submit" class="btn btn-success" style="margin-top: 1rem;">
                                <i class="fa fa-upload"></i> 開始上傳並處理
                            </button>
                        </div>
                    </div>
                </form>

                <!-- 上傳進度條 -->
                <div id="uploadProgress" class="progress-container" style="display: none;">
                    <h4><i class="fa fa-spinner fa-spin"></i> 檔案處理中...</h4>
                    <div class="progress progress-striped active">
                        <div class="progress-bar progress-bar-success" id="progressBar" style="width: 0%"></div>
                    </div>
                    <p style="text-align: center; margin-top: 1rem; color: var(--text-secondary);" id="progressText">準備中...</p>
                    
                    <!-- 處理步驟指示器 -->
                    <div class="processing-steps" id="processingSteps" style="margin-top: 2rem;">
                        <div class="step completed" id="step1">
                            <i class="fa fa-check"></i> 檔案上傳完成
                        </div>
                        <div class="step active" id="step2">
                            <i class="fa fa-cog fa-spin"></i> 音訊預處理中
                        </div>
                        <div class="step" id="step3">
                            <i class="fa fa-circle-o"></i> 語音轉文字
                        </div>
                        <div class="step" id="step4">
                            <i class="fa fa-circle-o"></i> 語者辨識
                        </div>
                        <div class="step" id="step5">
                            <i class="fa fa-circle-o"></i> 生成結果
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4 col-sm-12">
        <!-- 進階設定 -->
        <div class="x_panel fade-in">
            <div class="x_title">
                <h2><i class="fa fa-cogs"></i> 進階設定</h2>
                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                <div class="form-group">
                    <label for="numSpeakers">預期語者數量（可選）</label>
                    <input type="number" class="form-control" id="numSpeakers" name="num_speakers" 
                           min="1" max="10" placeholder="系統自動偵測" form="uploadForm"
                           style="border-radius: var(--radius-md); border: 1px solid var(--border-color); padding: 0.75rem;">
                    <small class="help-block" style="color: var(--text-secondary);">
                        如果您知道會議中的發言人數量，輸入此資訊可以提高語者辨識的準確度
                    </small>
                </div>
                
                <div class="form-group">
                    <div class="checkbox">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="autoProcess" checked form="uploadForm"> 
                            <span>上傳後自動開始處理</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label>音訊品質建議</label>
                    <div style="background: var(--bg-secondary); padding: 1rem; border-radius: var(--radius-md); margin-top: 0.5rem;">
                        <small style="color: var(--text-secondary); line-height: 1.6;">
                            • 建議使用清晰的錄音設備<br>
                            • 避免背景噪音干擾<br>
                            • 確保所有發言者音量適中<br>
                            • 建議音訊長度不超過 2 小時
                        </small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 處理說明 -->
        <div class="x_panel fade-in">
            <div class="x_title">
                <h2><i class="fa fa-question-circle"></i> AI 處理流程</h2>
                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-marker" style="background: var(--info-color);"></div>
                        <div class="timeline-content">
                            <h6 style="color: var(--text-primary); font-weight: 600;">1. 音訊預處理</h6>
                            <p style="color: var(--text-secondary); font-size: 0.9rem;">格式轉換與音質優化</p>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-marker" style="background: var(--primary-color);"></div>
                        <div class="timeline-content">
                            <h6 style="color: var(--text-primary); font-weight: 600;">2. 語音轉文字</h6>
                            <p style="color: var(--text-secondary); font-size: 0.9rem;">使用 OpenAI Whisper AI 進行轉錄</p>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-marker" style="background: var(--secondary-color);"></div>
                        <div class="timeline-content">
                            <h6 style="color: var(--text-primary); font-weight: 600;">3. 語者辨識</h6>
                            <p style="color: var(--text-secondary); font-size: 0.9rem;">智慧識別不同發言者</p>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-marker" style="background: var(--accent-color);"></div>
                        <div class="timeline-content">
                            <h6 style="color: var(--text-primary); font-weight: 600;">4. 智慧分析</h6>
                            <p style="color: var(--text-secondary); font-size: 0.9rem;">生成摘要與行動項目</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 最近的處理記錄 -->
<div class="row">
    <div class="col-md-12">
        <div class="x_panel fade-in">
            <div class="x_title">
                <h2><i class="fa fa-clock-o"></i> 最近的處理記錄</h2>
                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                <div id="recentMeetings">
                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        <i class="fa fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem; color: var(--primary-color);"></i>
                        <p>載入最近的會議記錄...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .timeline {
        position: relative;
        padding-left: 30px;
    }
    
    .timeline::before {
        content: '';
        position: absolute;
        left: 15px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: linear-gradient(to bottom, var(--info-color), var(--accent-color));
        opacity: 0.3;
    }
    
    .timeline-item {
        position: relative;
        margin-bottom: 20px;
    }
    
    .timeline-marker {
        position: absolute;
        left: -23px;
        top: 5px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 3px solid #fff;
        box-shadow: 0 0 0 2px var(--border-color);
    }
    
    .timeline-content h6 {
        margin: 0 0 5px 0;
        font-weight: bold;
    }
    
    .timeline-content p {
        margin: 0;
        font-size: 13px;
    }
    
    /* 自定義表單樣式 */
    .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const uploadProgress = document.getElementById('uploadProgress');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    
    // 拖放功能
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            handleFileSelection(files[0]);
        }
    });
    
    // 檔案選擇處理
    fileInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            handleFileSelection(e.target.files[0]);
        }
    });
    
    function handleFileSelection(file) {
        // 檢查檔案類型
        const allowedTypes = ['audio/m4a', 'audio/mp3', 'audio/mpeg', 'audio/wav', 'audio/flac', 'audio/webm'];
        const allowedExtensions = ['.m4a', '.mp3', '.wav', '.flac', '.webm'];
        
        const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
        
        if (!allowedExtensions.includes(fileExtension)) {
            showAlert('不支援的檔案格式！請選擇 M4A、MP3、WAV、FLAC 或 WebM 格式的檔案。', 'danger');
            return;
        }
        
        // 檢查檔案大小 (500MB 限制)
        if (file.size > 500 * 1024 * 1024) {
            showAlert('檔案太大！請選擇小於 500MB 的檔案。', 'danger');
            return;
        }
        
        // 顯示檔案資訊
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        fileInfo.style.display = 'block';
        
        // 添加動畫效果
        setTimeout(() => {
            fileInfo.classList.add('fade-in');
        }, 100);
    }
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // 表單提交處理
    $('#uploadForm').on('submit', function(e) {
        e.preventDefault();
        
        if (!fileInput.files[0]) {
            showAlert('請先選擇要上傳的檔案！', 'warning');
            return;
        }
        
        startUploadProcess();
    });
    
    function startUploadProcess() {
        // 隱藏上傳區域，顯示進度
        uploadArea.style.display = 'none';
        uploadProgress.style.display = 'block';
        
        // 模擬上傳和處理進度
        simulateProgress();
        
        // 實際的表單提交（可以在這裡使用 AJAX）
        const formData = new FormData(document.getElementById('uploadForm'));
        
        $.ajax({
            url: $('#uploadForm').attr('action'),
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                // 處理成功回應
                console.log('Upload successful');
            },
            error: function(xhr, status, error) {
                showAlert('上傳失敗：' + error, 'danger');
                // 重置介面
                resetUploadInterface();
            }
        });
    }
    
    function simulateProgress() {
        let progress = 0;
        const steps = [
            { text: '檔案上傳中...', step: 1 },
            { text: '音訊預處理中...', step: 2 },
            { text: '語音轉文字中...', step: 3 },
            { text: '語者辨識中...', step: 4 },
            { text: '生成結果中...', step: 5 }
        ];
        
        const interval = setInterval(() => {
            progress += Math.random() * 8 + 2; // 隨機增加 2-10%
            if (progress > 100) progress = 100;
            
            progressBar.style.width = progress + '%';
            
            // 更新步驟狀態
            const currentStep = Math.floor(progress / 20) + 1;
            updateProcessingSteps(currentStep, steps);
            
            if (currentStep <= steps.length) {
                progressText.textContent = steps[currentStep - 1].text;
            }
            
            if (progress >= 100) {
                clearInterval(interval);
                progressText.textContent = '✅ 處理完成！正在跳轉...';
                
                setTimeout(() => {
                    showAlert('🎉 檔案處理完成！即將跳轉到結果頁面...', 'success');
                    // 這裡可以跳轉到結果頁面
                    // window.location.href = '/meetings';
                }, 1000);
            }
        }, 300);
    }
    
    function updateProcessingSteps(currentStep, steps) {
        for (let i = 1; i <= 5; i++) {
            const stepElement = document.getElementById(`step${i}`);
            const icon = stepElement.querySelector('i');
            
            if (i < currentStep) {
                // 已完成的步驟
                stepElement.className = 'step completed';
                icon.className = 'fa fa-check';
            } else if (i === currentStep) {
                // 當前步驟
                stepElement.className = 'step active';
                icon.className = 'fa fa-cog fa-spin';
            } else {
                // 未開始的步驟
                stepElement.className = 'step';
                icon.className = 'fa fa-circle-o';
            }
        }
    }
    
    function showAlert(message, type) {
        const alertHtml = `
            <div class="alert alert-${type} alert-dismissible fade in" role="alert" style="margin-top: 1rem;">
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
                ${message}
            </div>
        `;
        
        // 在上傳區域前插入提醒
        $(alertHtml).insertBefore('#uploadArea');
        
        // 自動關閉
        setTimeout(() => {
            $('.alert').fadeOut();
        }, 5000);
    }
    
    function resetUploadInterface() {
        uploadArea.style.display = 'block';
        uploadProgress.style.display = 'none';
        fileInfo.style.display = 'none';
        progressBar.style.width = '0%';
    }
    
    // 載入最近的會議記錄
    loadRecentMeetings();
    
    function loadRecentMeetings() {
        // 模擬載入延遲
        setTimeout(() => {
            $('#recentMeetings').html(`
                <div style="text-align: center; padding: 2rem;">
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">尚無會議記錄</p>
                    <a href="${'{{ url_for("meetings_list") }}'}" class="btn btn-info">
                        <i class="fa fa-arrow-right"></i> 查看所有會議記錄
                    </a>
                </div>
            `);
        }, 1500);
    }
    
    // 頁面載入動畫
    const elements = document.querySelectorAll('.fade-in');
    elements.forEach((el, index) => {
        el.style.animationDelay = `${index * 0.1}s`;
    });
});
</script>
{% endblock %}
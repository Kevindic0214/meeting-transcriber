{% extends "base.html" %}

{% block title %}{{ meeting.original_filename }} - 會議詳情{% endblock %}
{% block page_title %}{{ meeting.original_filename|truncate(50) }}{% endblock %}

{% block page_actions %}
<a href="{{ url_for('meetings_list') }}" class="btn btn-secondary btn-sm">
    <i class="fa fa-arrow-left"></i> 返回列表
</a>
{% if meeting.status == 'completed' %}
<div class="btn-group">
    <button type="button" class="btn btn-success btn-sm dropdown-toggle" data-toggle="dropdown">
        <i class="fa fa-download"></i> 下載檔案 <span class="caret"></span>
    </button>
    <ul class="dropdown-menu">
        <li><a href="{{ url_for('download_file', meeting_id=meeting.id, file_type='srt') }}"><i class="fa fa-file-text"></i> 字幕檔 (SRT)</a></li>
        <li><a href="{{ url_for('download_file', meeting_id=meeting.id, file_type='speaker_srt') }}"><i class="fa fa-users"></i> 語者標註字幕</a></li>
        <li><a href="{{ url_for('download_file', meeting_id=meeting.id, file_type='rttm') }}"><i class="fa fa-clock"></i> 語者時間檔 (RTTM)</a></li>
    </ul>
</div>
{% endif %}
{% endblock %}

{% block content %}
<!-- 會議資訊卡片 -->
<div class="row">
    <div class="col-md-12">
        <div class="x_panel fade-in">
            <div class="x_title">
                <h2>
                    <i class="fa fa-info-circle"></i> 會議資訊
                    <span class="status-badge status-{{ meeting.status }}" style="margin-left: 1rem;">
                        {% if meeting.status == 'uploaded' %}
                            <i class="fa fa-clock"></i> 已上傳
                        {% elif meeting.status == 'processing' %}
                            <i class="fa fa-spinner fa-spin"></i> 處理中
                        {% elif meeting.status == 'completed' %}
                            <i class="fa fa-check-circle"></i> 已完成
                        {% elif meeting.status == 'failed' %}
                            <i class="fa fa-times-circle"></i> 失敗
                        {% endif %}
                    </span>
                </h2>
                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="width: 3rem; height: 3rem; background: linear-gradient(135deg, var(--primary-color), var(--primary-light)); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem;">
                            <i class="fa fa-file"></i>
                        </div>
                        <div>
                            <h4 style="margin: 0; font-size: 0.85rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px;">檔案名稱</h4>
                            <span style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary);">{{ meeting.original_filename }}</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="width: 3rem; height: 3rem; background: linear-gradient(135deg, var(--info-color), #1E40AF); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem;">
                            <i class="fa fa-calendar"></i>
                        </div>
                        <div>
                            <h4 style="margin: 0; font-size: 0.85rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px;">上傳時間</h4>
                            <span style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary);">{{ meeting.created_at if meeting.created_at else '-' }}</span>
                        </div>
                    </div>
                    
                    {% if meeting.duration %}
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="width: 3rem; height: 3rem; background: linear-gradient(135deg, var(--success-color), #047857); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem;">
                            <i class="fa fa-clock"></i>
                        </div>
                        <div>
                            <h4 style="margin: 0; font-size: 0.85rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px;">會議時長</h4>
                            <span style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary);">{{ "%.1f"|format(meeting.duration/60) }} 分鐘</span>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if meeting.num_speakers %}
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="width: 3rem; height: 3rem; background: linear-gradient(135deg, var(--accent-color), #D97706); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem;">
                            <i class="fa fa-users"></i>
                        </div>
                        <div>
                            <h4 style="margin: 0; font-size: 0.85rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px;">語者數量</h4>
                            <span style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary);">{{ meeting.num_speakers }} 位發言者</span>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                {% if meeting.error_message %}
                <div class="alert alert-danger" style="margin-top: 2rem;">
                    <h4><i class="fa fa-exclamation-triangle"></i> 處理錯誤</h4>
                    <p>{{ meeting.error_message }}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- 主要內容區域 -->
    <div class="col-md-8">
        {% if meeting.status == 'processing' %}
        <!-- 處理進度顯示 -->
        <div class="x_panel fade-in">
            <div class="x_title">
                <h2><i class="fa fa-spinner fa-spin"></i> 處理進度</h2>
                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                <div class="progress progress-striped active" style="margin-bottom: 2rem;">
                    <div class="progress-bar progress-bar-info" style="width: 65%"></div>
                </div>
                <p style="text-align: center; color: var(--text-secondary); margin-bottom: 2rem;">正在處理您的會議音訊，預計還需要幾分鐘時間...</p>
                
                <div class="processing-steps">
                    <div class="step completed">
                        <i class="fa fa-check"></i> 檔案上傳完成
                    </div>
                    <div class="step completed">
                        <i class="fa fa-check"></i> 音訊預處理完成
                    </div>
                    <div class="step active">
                        <i class="fa fa-cog fa-spin"></i> 語音轉文字進行中
                    </div>
                    <div class="step">
                        <i class="fa fa-circle-o"></i> 語者辨識
                    </div>
                    <div class="step">
                        <i class="fa fa-circle-o"></i> 生成結果檔案
                    </div>
                </div>
            </div>
        </div>
        {% elif meeting.status == 'completed' and meeting.speaker_srt_path %}
        <!-- 字幕預覽 -->
        <div class="x_panel fade-in">
            <div class="x_title">
                <h2><i class="fa fa-comments"></i> 會議記錄</h2>
                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                <div class="subtitle-controls" style="margin-bottom: 1rem;">
                    <button class="btn btn-info btn-sm" onclick="toggleSubtitleMode()">
                        <i class="fa fa-user-tag"></i> <span id="modeToggleText">隱藏語者標籤</span>
                    </button>
                    <button class="btn btn-success btn-sm" onclick="copySubtitleText()">
                        <i class="fa fa-copy"></i> 複製文字
                    </button>
                    <button class="btn btn-warning btn-sm" onclick="searchInTranscript()">
                        <i class="fa fa-search"></i> 搜尋內容
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="exportTranscript()">
                        <i class="fa fa-file-export"></i> 匯出文字
                    </button>
                </div>
                
                <div class="subtitle-preview" id="subtitlePreview">
                    <div style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                        <i class="fa fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <p>載入字幕內容中...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 會議摘要 -->
        <div class="x_panel fade-in">
            <div class="x_title">
                <h2><i class="fa fa-lightbulb"></i> AI 會議摘要</h2>
                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                <div style="background: linear-gradient(135deg, var(--bg-secondary), var(--bg-accent)); padding: 2rem; border-radius: var(--radius-lg); margin-bottom: 2rem;">
                    <h3 style="color: var(--primary-color); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fa fa-list-alt"></i> 主要討論點
                    </h3>
                    <ul style="margin-bottom: 2rem; padding-left: 1.5rem; line-height: 1.8; color: var(--text-primary);">
                        <li>產品開發策略與市場定位討論</li>
                        <li>技術架構優化方案評估</li>
                        <li>團隊資源配置與時程安排</li>
                        <li>用戶反饋分析與改進方向</li>
                    </ul>
                    
                    <h3 style="color: var(--success-color); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fa fa-check-square"></i> 決議事項
                    </h3>
                    <ul style="margin-bottom: 2rem; padding-left: 1.5rem; line-height: 1.8; color: var(--text-primary);">
                        <li>確認下季度產品路線圖</li>
                        <li>批准技術債務清理計劃</li>
                        <li>同意增加前端開發人力</li>
                        <li>設定用戶體驗改善目標</li>
                    </ul>
                    
                    <h3 style="color: var(--warning-color); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fa fa-tasks"></i> 行動項目
                    </h3>
                    <div style="background: var(--bg-primary); padding: 1.5rem; border-radius: var(--radius-md); border-left: 4px solid var(--warning-color);">
                        <div style="margin-bottom: 1rem;">
                            <strong style="color: var(--text-primary);">發言者A：</strong>
                            <span style="color: var(--text-secondary);">完成市場調研報告，截止日期：下週五</span>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <strong style="color: var(--text-primary);">發言者B：</strong>
                            <span style="color: var(--text-secondary);">技術架構文檔更新，截止日期：本週三</span>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <strong style="color: var(--text-primary);">發言者C：</strong>
                            <span style="color: var(--text-secondary);">招聘計劃制定，截止日期：下週一</span>
                        </div>
                        <div>
                            <strong style="color: var(--text-primary);">發言者D：</strong>
                            <span style="color: var(--text-secondary);">用戶訪談安排，截止日期：下週三</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- 側邊欄 -->
    <div class="col-md-4">
        <!-- 快速操作 -->
        <div class="x_panel fade-in">
            <div class="x_title">
                <h2><i class="fa fa-bolt"></i> 快速操作</h2>
                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                {% if meeting.status == 'completed' %}
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <a href="{{ url_for('download_file', meeting_id=meeting.id, file_type='speaker_srt') }}" 
                       class="btn btn-success" style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; text-decoration: none; border-radius: var(--radius-md);">
                        <div style="width: 2.5rem; height: 2.5rem; background: rgba(255,255,255,0.2); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center;">
                            <i class="fa fa-users"></i>
                        </div>
                        <div style="flex: 1; text-align: left;">
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">語者標註字幕</div>
                            <small style="opacity: 0.8;">包含發言者資訊的完整字幕</small>
                        </div>
                    </a>
                    
                    <button class="btn btn-info" onclick="shareResults()" style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; border-radius: var(--radius-md);">
                        <div style="width: 2.5rem; height: 2.5rem; background: rgba(255,255,255,0.2); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center;">
                            <i class="fa fa-share"></i>
                        </div>
                        <div style="flex: 1; text-align: left;">
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">分享結果</div>
                            <small style="opacity: 0.8;">生成分享連結或導出報告</small>
                        </div>
                    </button>
                    
                    <button class="btn btn-warning" onclick="editTranscript()" style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; border-radius: var(--radius-md);">
                        <div style="width: 2.5rem; height: 2.5rem; background: rgba(255,255,255,0.2); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center;">
                            <i class="fa fa-edit"></i>
                        </div>
                        <div style="flex: 1; text-align: left;">
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">編輯內容</div>
                            <small style="opacity: 0.8;">修正轉錄內容或語者標籤</small>
                        </div>
                    </button>
                </div>
                {% elif meeting.status == 'failed' %}
                <div class="alert alert-danger">
                    <h4><i class="fa fa-exclamation-triangle"></i> 處理失敗</h4>
                    <p>{{ meeting.error_message if meeting.error_message else '處理過程中發生未知錯誤' }}</p>
                    <button class="btn btn-warning" onclick="retryProcessing()">
                        <i class="fa fa-refresh"></i> 重新處理
                    </button>
                </div>
                {% elif meeting.status == 'processing' %}
                <div class="alert alert-info">
                    <h4><i class="fa fa-spinner fa-spin"></i> 處理中</h4>
                    <p>您的會議音訊正在處理中，處理時間取決於音訊長度。</p>
                    <div style="background: rgba(255,255,255,0.8); padding: 1rem; border-radius: var(--radius-md); margin-top: 1rem;">
                        <small style="color: var(--text-secondary);">
                            <i class="fa fa-info-circle"></i> 
                            預估剩餘時間：{{ "%.0f"|format((meeting.duration or 1800)/60 * 0.3) }} 分鐘
                        </small>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        {% if meeting.status == 'completed' and meeting.num_speakers %}
        <!-- 語者統計 -->
        <div class="x_panel fade-in">
            <div class="x_title">
                <h2><i class="fa fa-chart-pie"></i> 語者統計</h2>
                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                <div id="speakerStats">
                    <!-- 模擬語者統計數據 -->
                    {% for i in range(meeting.num_speakers) %}
                    <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: var(--radius-md); margin-bottom: 1rem; border-left: 4px solid var(--primary-color);">
                        <div style="width: 3rem; height: 3rem; background: linear-gradient(135deg, var(--primary-color), var(--primary-light)); border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 1.1rem;">
                            {{ ['A', 'B', 'C', 'D', 'E'][i] }}
                        </div>
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 0.5rem 0; font-size: 1rem; font-weight: 600; color: var(--text-primary);">發言者{{ ['A', 'B', 'C', 'D', 'E'][i] }}</h4>
                            <div style="display: flex; gap: 1rem; font-size: 0.8rem; color: var(--text-secondary);">
                                <span><i class="fa fa-clock"></i> {{ [12.8, 15.2, 10.5, 6.7, 4.8][i] }} 分鐘</span>
                                <span><i class="fa fa-percentage"></i> {{ [28.3, 33.6, 23.2, 14.9, 10.6][i] }}%</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- 相關操作 -->
        <div class="x_panel fade-in">
            <div class="x_title">
                <h2><i class="fa fa-cogs"></i> 更多操作</h2>
                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <button class="btn btn-secondary" onclick="generateReport()" style="justify-content: flex-start;">
                        <i class="fa fa-file-pdf"></i> 生成會議報告
                    </button>
                    <button class="btn btn-secondary" onclick="addToCalendar()" style="justify-content: flex-start;">
                        <i class="fa fa-calendar-plus"></i> 加入行事曆
                    </button>
                    <button class="btn btn-secondary" onclick="sendEmail()" style="justify-content: flex-start;">
                        <i class="fa fa-envelope"></i> 發送郵件摘要
                    </button>
                    <hr style="margin: 1rem 0; border-color: var(--border-light);">
                    <button class="btn btn-danger" onclick="deleteRecord()" style="justify-content: flex-start;">
                        <i class="fa fa-trash"></i> 刪除記錄
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 設置會議ID和狀態以供JavaScript使用
document.body.dataset.meetingId = "{{ meeting.id }}";
document.body.dataset.meetingStatus = "{{ meeting.status }}";
document.body.dataset.meetingFilename = "{{ meeting.original_filename }}";

// 全域變數來儲存字幕資料
let subtitleData = null;
let showSpeakers = true;

// 載入真實字幕內容的函數
function loadSubtitleContent() {
    const subtitlePreview = document.getElementById('subtitlePreview');
    const meetingId = document.body.dataset.meetingId;
    
    if (!meetingId) {
        showSubtitleError('無法取得會議ID');
        return;
    }
    
    // 顯示載入狀態，提供視覺反饋給用戶
    showLoadingState();
    
    // 首先嘗試載入結構化的字幕資料
    fetch(`/api/meeting/${meetingId}/subtitle/formatted`)
        .then(response => {
            if (!response.ok) {
                // 如果結構化 API 失敗，嘗試載入原始字幕內容
                console.warn('結構化字幕載入失敗，嘗試載入原始內容');
                return loadRawSubtitleContent(meetingId);
            }
            return response.json();
        })
        .then(data => {
            if (data && data.segments) {
                subtitleData = data.segments;
                displayStructuredSubtitles(data.segments);
                enableAdvancedFeatures();
            } else {
                throw new Error('結構化資料格式錯誤');
            }
        })
        .catch(error => {
            console.error('載入字幕失敗:', error);
            // 如果結構化載入失敗，嘗試載入原始內容作為備選方案
            loadRawSubtitleContent(meetingId);
        });
}

// 載入原始字幕內容作為備選方案
function loadRawSubtitleContent(meetingId) {
    return fetch(`/api/meeting/${meetingId}/subtitle`)
        .then(response => {
            if (!response.ok) {
                // 根據不同的錯誤狀態碼提供具體的錯誤訊息
                switch (response.status) {
                    case 404:
                        throw new Error('字幕檔案不存在或會議記錄不存在');
                    case 400:
                        throw new Error('會議尚未處理完成，請稍候再試');
                    case 500:
                        throw new Error('伺服器處理錯誤，請聯繫管理員');
                    default:
                        throw new Error(`載入失敗 (錯誤代碼: ${response.status})`);
                }
            }
            return response.text();
        })
        .then(rawContent => {
            if (rawContent && rawContent.trim()) {
                displayRawSubtitles(rawContent);
                enableBasicFeatures();
            } else {
                throw new Error('字幕內容為空');
            }
        })
        .catch(error => {
            console.error('載入原始字幕失敗:', error);
            showSubtitleError(error.message);
        });
}

// 顯示載入狀態
function showLoadingState() {
    const subtitlePreview = document.getElementById('subtitlePreview');
    subtitlePreview.innerHTML = `
        <div style="text-align: center; color: var(--text-secondary); padding: 3rem;">
            <div style="margin-bottom: 1.5rem;">
                <i class="fa fa-spinner fa-spin" style="font-size: 3rem; color: var(--primary-color);"></i>
            </div>
            <h4 style="margin-bottom: 0.5rem; color: var(--text-primary);">載入字幕內容中</h4>
            <p style="margin: 0; font-size: 0.9rem;">正在從伺服器獲取轉錄結果...</p>
            <div style="margin-top: 1.5rem;">
                <div style="width: 200px; height: 4px; background: var(--bg-accent); border-radius: 2px; margin: 0 auto; overflow: hidden;">
                    <div style="width: 100%; height: 100%; background: linear-gradient(90deg, var(--primary-color), var(--secondary-color)); animation: progressSlide 2s ease-in-out infinite;"></div>
                </div>
            </div>
        </div>
    `;
}

// 顯示結構化字幕內容
function displayStructuredSubtitles(segments) {
    const subtitlePreview = document.getElementById('subtitlePreview');
    
    if (!segments || segments.length === 0) {
        showSubtitleError('沒有可顯示的字幕內容');
        return;
    }
    
    // 建立結構化的字幕顯示
    let html = '<div class="structured-subtitles">';
    
    segments.forEach((segment, index) => {
        const speakerClass = showSpeakers ? '' : ' style="display: none;"';
        const speakerColor = getSpeakerColor(segment.speaker);
        
        // 記錄每個語者的顏色映射，幫助調試
        console.log(`段落 ${index}: 語者 "${segment.speaker}" -> 顏色: ${speakerColor}`);
        
        html += `
            <div class="subtitle-segment" data-index="${index}" data-start="${segment.start_time}" data-end="${segment.end_time}" data-speaker="${escapeHtml(segment.speaker)}">
                <div class="segment-header"${speakerClass}>
                    <span class="speaker-tag" style="background: ${speakerColor};" title="語者: ${escapeHtml(segment.speaker)}">
                        ${escapeHtml(segment.speaker)}
                    </span>
                    <span class="timestamp" onclick="seekToTime(${segment.start_time})" title="點擊跳轉到此時間點">
                        ${escapeHtml(segment.start_time_formatted)} - ${escapeHtml(segment.end_time_formatted)}
                    </span>
                </div>
                <div class="segment-content">
                    ${escapeHtml(segment.content)}
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    subtitlePreview.innerHTML = html;
    
    // 添加CSS樣式來美化顯示
    addSubtitleStyles();
    
    // 記錄成功顯示的統計信息
    const speakerCounts = {};
    segments.forEach(segment => {
        speakerCounts[segment.speaker] = (speakerCounts[segment.speaker] || 0) + 1;
    });
    
    console.log('字幕顯示完成，語者統計:', speakerCounts);
}

// 顯示原始字幕內容
function displayRawSubtitles(rawContent) {
    const subtitlePreview = document.getElementById('subtitlePreview');
    
    if (!rawContent || !rawContent.trim()) {
        showSubtitleError('字幕內容為空');
        return;
    }
    
    // 處理原始SRT內容，添加基本的格式化
    const formattedContent = formatRawSubtitles(rawContent);
    subtitlePreview.innerHTML = `<div class="raw-subtitles">${formattedContent}</div>`;
    
    // 啟用基本功能
    enableBasicFeatures();
}

// 格式化原始字幕內容
function formatRawSubtitles(content) {
    // 將純文字內容轉換為HTML，保持原有的換行和格式
    let formatted = escapeHtml(content).replace(/\n/g, '<br>');
    
    // 為數字格式的語者標籤添加樣式
    const numericSpeakerPatterns = [
        { pattern: /\[發言者(\d+)\]/g, replacement: '<span class="speaker-tag speaker-numeric-$1">[發言者$1]</span>' },
        { pattern: /\[語者(\d+)\]/g, replacement: '<span class="speaker-tag speaker-numeric-$1">[語者$1]</span>' },
        { pattern: /\[Speaker(\d+)\]/g, replacement: '<span class="speaker-tag speaker-numeric-$1">[Speaker$1]</span>' },
        { pattern: /\[SPEAKER_(\d+)\]/g, replacement: '<span class="speaker-tag speaker-numeric-$1">[SPEAKER_$1]</span>' },
    ];
    
    // 為字母格式的語者標籤添加樣式（向後相容）
    const letterSpeakerPatterns = [
        { pattern: /\[發言者([A-Z])\]/g, replacement: '<span class="speaker-tag speaker-letter-$1">[發言者$1]</span>' },
        { pattern: /\[Speaker ([A-Z])\]/g, replacement: '<span class="speaker-tag speaker-letter-$1">[Speaker $1]</span>' },
        { pattern: /\[語者([A-Z])\]/g, replacement: '<span class="speaker-tag speaker-letter-$1">[語者$1]</span>' },
    ];
    
    // 應用數字格式的樣式
    numericSpeakerPatterns.forEach(({ pattern, replacement }) => {
        formatted = formatted.replace(pattern, replacement);
    });
    
    // 應用字母格式的樣式
    letterSpeakerPatterns.forEach(({ pattern, replacement }) => {
        formatted = formatted.replace(pattern, replacement);
    });
    
    return formatted;
}

// 顯示錯誤狀態
function showSubtitleError(errorMessage) {
    const subtitlePreview = document.getElementById('subtitlePreview');
    subtitlePreview.innerHTML = `
        <div style="text-align: center; color: var(--danger-color); padding: 3rem;">
            <div style="margin-bottom: 1.5rem;">
                <i class="fa fa-exclamation-triangle" style="font-size: 3rem;"></i>
            </div>
            <h4 style="margin-bottom: 1rem;">載入字幕失敗</h4>
            <p style="margin-bottom: 2rem; color: var(--text-secondary);">${escapeHtml(errorMessage)}</p>
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button class="btn btn-primary" onclick="loadSubtitleContent()">
                    <i class="fa fa-refresh"></i> 重新載入
                </button>
                <button class="btn btn-secondary" onclick="contactSupport()">
                    <i class="fa fa-support"></i> 聯繫支援
                </button>
            </div>
        </div>
    `;
}

// 啟用進階功能（當有結構化資料時）
function enableAdvancedFeatures() {
    console.log('進階字幕功能已啟用');
}

// 啟用基本功能（當只有原始內容時）
function enableBasicFeatures() {
    console.log('基本字幕功能已啟用');
}

// 語者模式切換功能
function toggleSubtitleMode() {
    const modeText = document.getElementById('modeToggleText');
    const speakerElements = document.querySelectorAll('.speaker-tag, .segment-header');
    
    showSpeakers = !showSpeakers;
    
    speakerElements.forEach(element => {
        if (element.classList.contains('segment-header')) {
            element.style.display = showSpeakers ? 'flex' : 'none';
        } else {
            element.style.display = showSpeakers ? 'inline' : 'none';
        }
    });
    
    modeText.textContent = showSpeakers ? '隱藏語者標籤' : '顯示語者標籤';
    localStorage.setItem('showSpeakers', showSpeakers.toString());
    
    // 記錄切換操作，幫助調試
    console.log(`語者標籤顯示模式切換為: ${showSpeakers ? '顯示' : '隱藏'}`);
}

// 複製字幕文字功能
function copySubtitleText() {
    let textToCopy = '';
    
    if (subtitleData && subtitleData.length > 0) {
        textToCopy = subtitleData.map(segment => {
            if (showSpeakers) {
                return `[${segment.speaker}] (${segment.start_time_formatted} - ${segment.end_time_formatted})\n${segment.content}\n`;
            } else {
                return segment.content;
            }
        }).join('\n\n');
    } else {
        const subtitlePreview = document.getElementById('subtitlePreview');
        textToCopy = subtitlePreview.textContent || subtitlePreview.innerText;
    }
    
    navigator.clipboard.writeText(textToCopy).then(() => {
        showNotification('✅ 轉錄內容已複製到剪貼板！', 'success');
    }).catch(error => {
        console.error('複製失敗:', error);
        fallbackCopyText(textToCopy);
    });
}

// 備選複製方法
function fallbackCopyText(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    document.body.appendChild(textArea);
    textArea.select();
    
    try {
        document.execCommand('copy');
        showNotification('✅ 轉錄內容已複製到剪貼板！', 'success');
    } catch (error) {
        showNotification('❌ 複製失敗，請手動選擇文字複製。', 'error');
    }
    
    document.body.removeChild(textArea);
}

// 搜尋轉錄內容功能
function searchInTranscript() {
    const searchTerm = prompt('請輸入要搜尋的內容：');
    if (!searchTerm || !searchTerm.trim()) return;
    
    const subtitlePreview = document.getElementById('subtitlePreview');
    const searchRegex = new RegExp(`(${escapeRegex(searchTerm.trim())})`, 'gi');
    let foundCount = 0;
    
    if (subtitleData && subtitleData.length > 0) {
        foundCount = searchInStructuredContent(searchRegex);
    } else {
        foundCount = searchInRawContent(searchRegex);
    }
    
    if (foundCount > 0) {
        showNotification(`✅ 找到 ${foundCount} 個匹配項目，已高亮顯示。`, 'success');
        const firstMatch = subtitlePreview.querySelector('mark');
        if (firstMatch) {
            firstMatch.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    } else {
        showNotification('❌ 未找到匹配的內容。', 'error');
    }
}

// 在結構化內容中搜尋
function searchInStructuredContent(searchRegex) {
    let foundCount = 0;
    const segments = document.querySelectorAll('.segment-content');
    
    segments.forEach(segment => {
        const originalText = segment.textContent;
        const highlightedText = originalText.replace(searchRegex, (match) => {
            foundCount++;
            return `<mark style="background: #FEF3C7; padding: 2px 4px; border-radius: 3px; font-weight: bold;">${match}</mark>`;
        });
        
        if (highlightedText !== originalText) {
            segment.innerHTML = highlightedText;
        }
    });
    
    return foundCount;
}

// 在原始內容中搜尋
function searchInRawContent(searchRegex) {
    const subtitlePreview = document.getElementById('subtitlePreview');
    const originalText = subtitlePreview.textContent;
    let foundCount = 0;
    
    const highlightedText = originalText.replace(searchRegex, (match) => {
        foundCount++;
        return `<mark style="background: #FEF3C7; padding: 2px 4px; border-radius: 3px; font-weight: bold;">${match}</mark>`;
    });
    
    if (foundCount > 0) {
        subtitlePreview.innerHTML = highlightedText.replace(/\n/g, '<br>');
    }
    
    return foundCount;
}

// 匯出轉錄內容功能
function exportTranscript() {
    let content = '';
    const meetingFilename = document.body.dataset.meetingFilename || 'meeting';
    
    if (subtitleData && subtitleData.length > 0) {
        content = generateDetailedExport();
        downloadTextFile(content, `${meetingFilename}_detailed_transcript.txt`);
    } else {
        const subtitlePreview = document.getElementById('subtitlePreview');
        content = subtitlePreview.textContent || subtitlePreview.innerText;
        downloadTextFile(content, `${meetingFilename}_transcript.txt`);
    }
    
    showNotification('✅ 轉錄內容已匯出！', 'success');
}

// 生成詳細的匯出內容
function generateDetailedExport() {
    const meeting = {
        filename: document.body.dataset.meetingFilename || '未知檔案',
        date: new Date().toLocaleDateString('zh-TW'),
        totalSegments: subtitleData.length,
        totalDuration: subtitleData.length > 0 ? subtitleData[subtitleData.length - 1].end_time : 0
    };
    
    let content = `會議轉錄報告
=====================================
檔案名稱: ${meeting.filename}
匯出日期: ${meeting.date}
總段落數: ${meeting.totalSegments}
會議時長: ${formatTime(meeting.totalDuration)}

詳細內容:
=====================================

`;
    
    subtitleData.forEach((segment, index) => {
        content += `${index + 1}. [${segment.speaker}] (${segment.start_time_formatted} - ${segment.end_time_formatted})\n`;
        content += `${segment.content}\n\n`;
    });
    
    content += `=====================================
報告結束 - 由 AI 會議助手生成`;
    
    return content;
}

// 工具函數
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function escapeRegex(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

// 工具函數：獲取語者顏色（支援數字格式的語者標籤）
function getSpeakerColor(speaker) {
    // 為數字格式的語者標籤提供顏色映射
    const numericColors = {
        '發言者00': 'linear-gradient(135deg, #4F46E5, #6366F1)',
        '發言者01': 'linear-gradient(135deg, #10B981, #047857)',
        '發言者02': 'linear-gradient(135deg, #F59E0B, #D97706)',
        '發言者03': 'linear-gradient(135deg, #EF4444, #DC2626)',
        '發言者04': 'linear-gradient(135deg, #8B5CF6, #7C3AED)',
        '發言者05': 'linear-gradient(135deg, #06B6D4, #0891B2)',
        '發言者06': 'linear-gradient(135deg, #84CC16, #65A30D)',
        '發言者07': 'linear-gradient(135deg, #F97316, #EA580C)',
        '發言者08': 'linear-gradient(135deg, #EC4899, #DB2777)',
        '發言者09': 'linear-gradient(135deg, #6366F1, #4F46E5)',
    };
    
    // 傳統字母格式的語者標籤顏色映射（向後相容）
    const letterColors = {
        '發言者A': 'linear-gradient(135deg, #4F46E5, #6366F1)',
        '發言者B': 'linear-gradient(135deg, #10B981, #047857)',
        '發言者C': 'linear-gradient(135deg, #F59E0B, #D97706)',
        '發言者D': 'linear-gradient(135deg, #EF4444, #DC2626)',
        '發言者E': 'linear-gradient(135deg, #8B5CF6, #7C3AED)',
    };
    
    // 首先檢查數字格式
    if (numericColors[speaker]) {
        return numericColors[speaker];
    }
    
    // 然後檢查字母格式
    if (letterColors[speaker]) {
        return letterColors[speaker];
    }
    
    // 如果都沒有匹配，嘗試從語者名稱中提取數字或字母
    const numericMatch = speaker.match(/(\d+)/);
    if (numericMatch) {
        const number = parseInt(numericMatch[1]);
        const colorIndex = number % 10; // 使用模運算來循環使用顏色
        const colorArray = Object.values(numericColors);
        return colorArray[colorIndex];
    }
    
    const letterMatch = speaker.match(/([A-Z])/);
    if (letterMatch) {
        const letter = letterMatch[1];
        const colorIndex = letter.charCodeAt(0) - 65; // A=0, B=1, C=2...
        const colorArray = Object.values(letterColors);
        return colorArray[colorIndex % colorArray.length];
    }
    
    // 預設顏色（用於未知或無法識別的語者）
    return 'linear-gradient(135deg, #6B7280, #4B5563)';
}

function seekToTime(seconds) {
    console.log(`跳轉到時間: ${seconds} 秒`);
    showNotification(`📍 時間戳記: ${formatTime(seconds)}`, 'info');
}

function formatTime(seconds) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = Math.floor(seconds % 60);
    
    if (hours > 0) {
        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    } else {
        return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }
}

function downloadTextFile(content, filename) {
    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.style.display = 'none';
    
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// 字幕樣式
function addSubtitleStyles() {
    // 檢查是否已經添加過樣式，避免重複添加造成樣式衝突
    if (document.getElementById('subtitle-styles')) return;
    
    const style = document.createElement('style');
    style.id = 'subtitle-styles';
    
    style.textContent = `
        /* 字幕容器的基礎樣式 */
        .structured-subtitles {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            /* 使用等寬字體確保時間戳記對齊 */
            width: 100%; /* 設定寬度與父容器相同 */
            overflow-y: auto; /* 啟用垂直滾動 */
            overflow-x: auto; /* 防止長句子導致水平滾動問題 */
        }
        
        /* 個別字幕段落的緊湊化設計 */
        .subtitle-segment {
            display: inline-flex;
            
            padding: 0.4rem 0.6rem;
            
            /* 這個小間距足以區分不同段落，但不會造成過度分離 */
            margin-bottom: 0.1rem;
            
            border-radius: var(--radius-md);
            transition: background-color 0.2s ease, border-left-color 0.2s ease;
            border-left: 3px solid transparent;
            
            /* 新增：確保高度完全由內容決定，不設置最小高度 */
            min-height: unset;
            
            /* 新增：控制內部元素不產生額外的外邊距 */
            overflow: hidden;
        }
        
        /* 懸停效果保持不變，但過渡更加流暢 */
        .subtitle-segment:hover {
            background-color: var(--bg-hover);
            border-left-color: var(--primary-color);
            /* 輕微的陰影效果增強互動反饋 */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        /* 語者信息區域的緊湊化設計 */
        .segment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            
            margin-bottom: 0.4rem;
            
            font-size: 0.75rem; /* 稍微縮小字體，節省垂直空間 */
            
            /* 新增：控制行高，確保緊湊顯示 */
            line-height: 1.5;
            
            /* 新增：防止內容換行造成不必要的高度增加 */
            white-space: nowrap;
            
            /* 新增：確保不會有額外的外邊距 */
            margin-top: 0;

            margin-bottom: 0.25rem;
        }
        
        /* 語者標籤的精細調整 */
        .speaker-tag {
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-sm);
            color: white;
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            flex-shrink: 0;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* 時間戳記的優化設計 */
        .timestamp {
            color: var(--text-light);
            font-family: monospace;
            cursor: pointer;
            transition: color 0.2s ease;
            
            /* 新增：確保時間戳記不會被壓縮 */
            flex-shrink: 0;
            
            /* 新增：統一的字體大小確保整齊對齊 */
            font-size: 0.8rem;
            
            /* 新增：輕微的背景色增強可讀性 */
            background: rgba(0, 0, 0, 0.05);
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
        }
        
        .timestamp:hover {
            color: var(--primary-color);
            text-decoration: underline;
            /* 新增：懸停時的背景色變化 */
            background: rgba(79, 70, 229, 0.1);
        }
        
        /* 內容文字區域的緊湊化 */
        .segment-content {
            color: var(--text-primary);
            
            line-height: 1.35;
            
            font-size: 0.85rem;
            
            /* 新增：確保沒有任何額外的邊距和內邊距 */
            margin: 0;
            padding: 0;
            
            /* 新增：優化文字渲染，提升在小字體下的清晰度 */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            
            /* 新增：確保長單詞不會撐破容器 */
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        /* 原始字幕內容的樣式調整 */
        .raw-subtitles {
            line-height: 1.5; /* 從 1.8 降到 1.5 */
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            font-size: 0.9rem; /* 稍微縮小字體 */
            
            /* 新增：改善原始字幕的間距 */
            padding: 0.5rem;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
        }
        
        /* 載入動畫保持原有的流暢效果 */
        @keyframes progressSlide {
            0% { transform: translateX(-100%); }
            50% { transform: translateX(0%); }
            100% { transform: translateX(100%); }
        }
        
        /* 搜尋高亮效果的優化 */
        mark {
            /* 使用更柔和的高亮效果，避免視覺干擾 */
            background: linear-gradient(120deg, #FEF3C7 0%, #FCD34D 100%);
            padding: 1px 3px; /* 從 2px 4px 縮減 */
            border-radius: 2px;
            font-weight: 500; /* 減少字重，避免過於突出 */
            animation: highlightPulse 1s ease-in-out;
        }
        
        @keyframes highlightPulse {
            0% { background: linear-gradient(120deg, #FEF3C7 0%, #FCD34D 100%); }
            50% { background: linear-gradient(120deg, #FCD34D 0%, #F59E0B 100%); }
            100% { background: linear-gradient(120deg, #FEF3C7 0%, #FCD34D 100%); }
        }
        

        
        /* 新增：印刷樣式的優化 */
        @media print {
            .subtitle-segment {
                padding: 0.3rem 0.5rem;
                margin-bottom: 0.2rem;
                border: 1px solid #ccc;
                break-inside: avoid; /* 避免段落被分頁切斷 */
            }
            
            .timestamp {
                background: transparent !important;
                color: #666 !important;
            }
            
            .speaker-tag {
                background: #f0f0f0 !important;
                color: #333 !important;
            }
        }
        
        /* 新增：輔助功能優化 */
        @media (prefers-reduced-motion: reduce) {
            /* 為有動作敏感性的用戶關閉動畫 */
            .subtitle-segment,
            .timestamp,
            mark {
                transition: none !important;
                animation: none !important;
            }
        }
        
    `;
    
    // 將樣式添加到頁面頭部
    document.head.appendChild(style);
    
}

function contactSupport() {
    const supportInfo = `
如果您遇到問題，請提供以下資訊：

• 會議ID: ${document.body.dataset.meetingId}
• 瀏覽器: ${navigator.userAgent}
• 時間: ${new Date().toISOString()}
• 錯誤描述: 字幕載入失敗
    `;
    
    if (confirm('是否要複製支援資訊到剪貼板？')) {
        navigator.clipboard.writeText(supportInfo).then(() => {
            showNotification('✅ 支援資訊已複製，請聯繫技術支援團隊', 'info');
        });
    }
}

// 狀態檢查功能
function startStatusCheck() {
    const meetingId = document.body.dataset.meetingId;
    
    const checkStatus = () => {
        fetch(`/api/meeting/${meetingId}/status`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'completed' || data.status === 'failed') {
                    console.log(`狀態改變為 ${data.status}，重新載入頁面`);
                    location.reload();
                }
            })
            .catch(error => {
                console.error('狀態檢查失敗:', error);
                if (window.statusCheckFailCount) {
                    window.statusCheckFailCount++;
                } else {
                    window.statusCheckFailCount = 1;
                }
                
                if (window.statusCheckFailCount >= 3) {
                    clearInterval(window.statusInterval);
                    console.log('狀態檢查連續失敗，已停止檢查');
                }
            });
    };
    
    window.statusInterval = setInterval(checkStatus, 5000);
    
    window.addEventListener('beforeunload', () => {
        if (window.statusInterval) {
            clearInterval(window.statusInterval);
        }
    });
}

// 其他功能保持不變
function shareResults() {
    const shareData = {
        title: '{{ meeting.original_filename }} - 會議記錄',
        text: '查看這個會議的AI轉錄結果和摘要',
        url: window.location.href
    };
    
    if (navigator.share) {
        navigator.share(shareData);
    } else {
        navigator.clipboard.writeText(window.location.href).then(() => {
            showNotification('✅ 分享連結已複製到剪貼板！', 'success');
        });
    }
}

function editTranscript() {
    showNotification('📝 編輯功能開發中，敬請期待...', 'info');
}

function retryProcessing() {
    if (confirm('確定要重新處理這個會議音訊嗎？')) {
        const meetingId = document.body.dataset.meetingId;
        showNotification('🔄 已開始重新處理，請稍候...', 'info');
        setTimeout(() => {
            location.reload();
        }, 2000);
    }
}

function generateReport() {
    showNotification('📊 正在生成PDF報告...', 'info');
    setTimeout(() => {
        showNotification('✅ 會議報告已生成並下載！', 'success');
    }, 2000);
}

function addToCalendar() {
    showNotification('📅 行事曆功能開發中...', 'info');
}

function sendEmail() {
    const email = prompt('請輸入要發送摘要的郵件地址：');
    if (email && email.includes('@')) {
        showNotification(`📧 會議摘要已發送至 ${email}`, 'success');
    }
}

function deleteRecord() {
    if (confirm('確定要刪除這個會議記錄嗎？這個操作無法復原。')) {
        showNotification('🗑️ 正在刪除記錄...', 'info');
        setTimeout(() => {
            window.location.href = "{{ url_for('meetings_list') }}";
        }, 1000);
    }
}

function showNotification(message, type = 'info') {
    const alertClass = type === 'success' ? 'alert-success' : 
                      type === 'error' ? 'alert-danger' : 'alert-info';
    
    const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade in" role="alert" style="position: fixed; top: 80px; right: 20px; z-index: 9999; min-width: 300px;">
            <button type="button" class="close" data-dismiss="alert">
                <span aria-hidden="true">×</span>
            </button>
            ${message}
        </div>
    `;
    
    $('body').append(alertHtml);
    
    setTimeout(() => {
        $('.alert').fadeOut();
    }, 3000);
}

// 初始化函數
function initializeMeetingDetail() {
    const meetingId = document.body.dataset.meetingId;
    const meetingStatus = document.body.dataset.meetingStatus;
    
    console.log(`初始化會議詳情頁面 - ID: ${meetingId}, 狀態: ${meetingStatus}`);
    
    if (meetingStatus === "processing") {
        startStatusCheck();
    }
    
    if (meetingStatus === "completed") {
        loadSubtitleContent();
    }
    
    // 恢復用戶偏好設定
    const savedShowSpeakers = localStorage.getItem('showSpeakers');
    if (savedShowSpeakers !== null) {
        showSpeakers = savedShowSpeakers === 'true';
        const modeText = document.getElementById('modeToggleText');
        if (modeText) {
            modeText.textContent = showSpeakers ? '隱藏語者標籤' : '顯示語者標籤';
        }
    }
    
    // 頁面載入動畫
    const elements = document.querySelectorAll('.fade-in');
    elements.forEach((el, index) => {
        el.style.animationDelay = `${index * 0.1}s`;
    });
}

// 頁面載入完成後初始化
document.addEventListener('DOMContentLoaded', initializeMeetingDetail);
</script>
{% endblock %}
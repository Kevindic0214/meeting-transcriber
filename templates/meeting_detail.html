{% extends "base.html" %}

{% block title %}{{ meeting.original_filename }} - æœƒè­°è©³æƒ…{% endblock %}
{% block page_title %}{{ meeting.original_filename|truncate(50) }}{% endblock %}

{% block page_actions %}
<a href="{{ url_for('meetings_list') }}" class="btn btn-secondary btn-sm">
    <i class="fa fa-arrow-left"></i> è¿”å›åˆ—è¡¨
</a>
{% if meeting.status == 'completed' %}
<div class="btn-group">
    <button type="button" class="btn btn-success btn-sm dropdown-toggle" data-toggle="dropdown">
        <i class="fa fa-download"></i> ä¸‹è¼‰æª”æ¡ˆ <span class="caret"></span>
    </button>
    <ul class="dropdown-menu">
        <li><a href="{{ url_for('download_file', meeting_id=meeting.id, file_type='srt') }}"><i class="fa fa-file-text"></i> å­—å¹•æª” (SRT)</a></li>
        <li><a href="{{ url_for('download_file', meeting_id=meeting.id, file_type='speaker_srt') }}"><i class="fa fa-users"></i> èªè€…æ¨™è¨»å­—å¹•</a></li>
        <li><a href="{{ url_for('download_file', meeting_id=meeting.id, file_type='rttm') }}"><i class="fa fa-clock"></i> èªè€…æ™‚é–“æª” (RTTM)</a></li>
    </ul>
</div>
{% endif %}
{% endblock %}

{% block content %}
<!-- æœƒè­°è³‡è¨Šå¡ç‰‡ -->
<div class="row">
    <div class="col-md-12">
        <div class="x_panel fade-in">
            <div class="x_title">
                <h2>
                    <i class="fa fa-info-circle"></i> æœƒè­°è³‡è¨Š
                    <span class="status-badge status-{{ meeting.status }}" style="margin-left: 1rem;">
                        {% if meeting.status == 'uploaded' %}
                            <i class="fa fa-clock"></i> å·²ä¸Šå‚³
                        {% elif meeting.status == 'processing' %}
                            <i class="fa fa-spinner fa-spin"></i> è™•ç†ä¸­
                        {% elif meeting.status == 'completed' %}
                            <i class="fa fa-check-circle"></i> å·²å®Œæˆ
                        {% elif meeting.status == 'failed' %}
                            <i class="fa fa-times-circle"></i> å¤±æ•—
                        {% endif %}
                    </span>
                </h2>
                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="width: 3rem; height: 3rem; background: linear-gradient(135deg, var(--primary-color), var(--primary-light)); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem;">
                            <i class="fa fa-file"></i>
                        </div>
                        <div>
                            <h4 style="margin: 0; font-size: 0.85rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px;">æª”æ¡ˆåç¨±</h4>
                            <span style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary);">{{ meeting.original_filename }}</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="width: 3rem; height: 3rem; background: linear-gradient(135deg, var(--info-color), #1E40AF); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem;">
                            <i class="fa fa-calendar"></i>
                        </div>
                        <div>
                            <h4 style="margin: 0; font-size: 0.85rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px;">ä¸Šå‚³æ™‚é–“</h4>
                            <span style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary);">{{ meeting.created_at if meeting.created_at else '-' }}</span>
                        </div>
                    </div>
                    
                    {% if meeting.duration %}
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="width: 3rem; height: 3rem; background: linear-gradient(135deg, var(--success-color), #047857); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem;">
                            <i class="fa fa-clock"></i>
                        </div>
                        <div>
                            <h4 style="margin: 0; font-size: 0.85rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px;">æœƒè­°æ™‚é•·</h4>
                            <span style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary);">{{ "%.1f"|format(meeting.duration/60) }} åˆ†é˜</span>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if meeting.num_speakers %}
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="width: 3rem; height: 3rem; background: linear-gradient(135deg, var(--accent-color), #D97706); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem;">
                            <i class="fa fa-users"></i>
                        </div>
                        <div>
                            <h4 style="margin: 0; font-size: 0.85rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px;">èªè€…æ•¸é‡</h4>
                            <span style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary);">{{ meeting.num_speakers }} ä½ç™¼è¨€è€…</span>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                {% if meeting.error_message %}
                <div class="alert alert-danger" style="margin-top: 2rem;">
                    <h4><i class="fa fa-exclamation-triangle"></i> è™•ç†éŒ¯èª¤</h4>
                    <p>{{ meeting.error_message }}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- ä¸»è¦å…§å®¹å€åŸŸ -->
    <div class="col-md-8">
        {% if meeting.status == 'processing' %}
        <!-- è™•ç†é€²åº¦é¡¯ç¤º -->
        <div class="x_panel fade-in">
            <div class="x_title">
                <h2><i class="fa fa-spinner fa-spin"></i> è™•ç†é€²åº¦</h2>
                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                <div class="progress progress-striped active" style="margin-bottom: 2rem;">
                    <div class="progress-bar progress-bar-info" style="width: 65%"></div>
                </div>
                <p style="text-align: center; color: var(--text-secondary); margin-bottom: 2rem;">æ­£åœ¨è™•ç†æ‚¨çš„æœƒè­°éŸ³è¨Šï¼Œé è¨ˆé‚„éœ€è¦å¹¾åˆ†é˜æ™‚é–“...</p>
                
                <div class="processing-steps">
                    <div class="step completed">
                        <i class="fa fa-check"></i> æª”æ¡ˆä¸Šå‚³å®Œæˆ
                    </div>
                    <div class="step completed">
                        <i class="fa fa-check"></i> éŸ³è¨Šé è™•ç†å®Œæˆ
                    </div>
                    <div class="step active">
                        <i class="fa fa-cog fa-spin"></i> èªéŸ³è½‰æ–‡å­—é€²è¡Œä¸­
                    </div>
                    <div class="step">
                        <i class="fa fa-circle-o"></i> èªè€…è¾¨è­˜
                    </div>
                    <div class="step">
                        <i class="fa fa-circle-o"></i> ç”Ÿæˆçµæœæª”æ¡ˆ
                    </div>
                </div>
            </div>
        </div>
        {% elif meeting.status == 'completed' and meeting.speaker_srt_path %}
        <!-- å­—å¹•é è¦½ -->
        <div class="x_panel fade-in">
            <div class="x_title">
                <h2><i class="fa fa-comments"></i> æœƒè­°è¨˜éŒ„</h2>
                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                <div class="subtitle-controls" style="margin-bottom: 1rem;">
                    <button class="btn btn-info btn-sm" onclick="toggleSubtitleMode()">
                        <i class="fa fa-user-tag"></i> <span id="modeToggleText">éš±è—èªè€…æ¨™ç±¤</span>
                    </button>
                    <button class="btn btn-success btn-sm" onclick="copySubtitleText()">
                        <i class="fa fa-copy"></i> è¤‡è£½æ–‡å­—
                    </button>
                    <button class="btn btn-warning btn-sm" onclick="searchInTranscript()">
                        <i class="fa fa-search"></i> æœå°‹å…§å®¹
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="exportTranscript()">
                        <i class="fa fa-file-export"></i> åŒ¯å‡ºæ–‡å­—
                    </button>
                </div>
                
                <div class="subtitle-preview" id="subtitlePreview">
                    <div style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                        <i class="fa fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <p>è¼‰å…¥å­—å¹•å…§å®¹ä¸­...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- æœƒè­°æ‘˜è¦ -->
        <div class="x_panel fade-in">
            <div class="x_title">
                <h2><i class="fa fa-lightbulb"></i> AI æœƒè­°æ‘˜è¦</h2>
                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                <div style="background: linear-gradient(135deg, var(--bg-secondary), var(--bg-accent)); padding: 2rem; border-radius: var(--radius-lg); margin-bottom: 2rem;">
                    <h3 style="color: var(--primary-color); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fa fa-list-alt"></i> ä¸»è¦è¨è«–é»
                    </h3>
                    <ul style="margin-bottom: 2rem; padding-left: 1.5rem; line-height: 1.8; color: var(--text-primary);">
                        <li>ç”¢å“é–‹ç™¼ç­–ç•¥èˆ‡å¸‚å ´å®šä½è¨è«–</li>
                        <li>æŠ€è¡“æ¶æ§‹å„ªåŒ–æ–¹æ¡ˆè©•ä¼°</li>
                        <li>åœ˜éšŠè³‡æºé…ç½®èˆ‡æ™‚ç¨‹å®‰æ’</li>
                        <li>ç”¨æˆ¶åé¥‹åˆ†æèˆ‡æ”¹é€²æ–¹å‘</li>
                    </ul>
                    
                    <h3 style="color: var(--success-color); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fa fa-check-square"></i> æ±ºè­°äº‹é …
                    </h3>
                    <ul style="margin-bottom: 2rem; padding-left: 1.5rem; line-height: 1.8; color: var(--text-primary);">
                        <li>ç¢ºèªä¸‹å­£åº¦ç”¢å“è·¯ç·šåœ–</li>
                        <li>æ‰¹å‡†æŠ€è¡“å‚µå‹™æ¸…ç†è¨ˆåŠƒ</li>
                        <li>åŒæ„å¢åŠ å‰ç«¯é–‹ç™¼äººåŠ›</li>
                        <li>è¨­å®šç”¨æˆ¶é«”é©—æ”¹å–„ç›®æ¨™</li>
                    </ul>
                    
                    <h3 style="color: var(--warning-color); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fa fa-tasks"></i> è¡Œå‹•é …ç›®
                    </h3>
                    <div style="background: var(--bg-primary); padding: 1.5rem; border-radius: var(--radius-md); border-left: 4px solid var(--warning-color);">
                        <div style="margin-bottom: 1rem;">
                            <strong style="color: var(--text-primary);">ç™¼è¨€è€…Aï¼š</strong>
                            <span style="color: var(--text-secondary);">å®Œæˆå¸‚å ´èª¿ç ”å ±å‘Šï¼Œæˆªæ­¢æ—¥æœŸï¼šä¸‹é€±äº”</span>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <strong style="color: var(--text-primary);">ç™¼è¨€è€…Bï¼š</strong>
                            <span style="color: var(--text-secondary);">æŠ€è¡“æ¶æ§‹æ–‡æª”æ›´æ–°ï¼Œæˆªæ­¢æ—¥æœŸï¼šæœ¬é€±ä¸‰</span>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <strong style="color: var(--text-primary);">ç™¼è¨€è€…Cï¼š</strong>
                            <span style="color: var(--text-secondary);">æ‹›è˜è¨ˆåŠƒåˆ¶å®šï¼Œæˆªæ­¢æ—¥æœŸï¼šä¸‹é€±ä¸€</span>
                        </div>
                        <div>
                            <strong style="color: var(--text-primary);">ç™¼è¨€è€…Dï¼š</strong>
                            <span style="color: var(--text-secondary);">ç”¨æˆ¶è¨ªè«‡å®‰æ’ï¼Œæˆªæ­¢æ—¥æœŸï¼šä¸‹é€±ä¸‰</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- å´é‚Šæ¬„ -->
    <div class="col-md-4">
        <!-- å¿«é€Ÿæ“ä½œ -->
        <div class="x_panel fade-in">
            <div class="x_title">
                <h2><i class="fa fa-bolt"></i> å¿«é€Ÿæ“ä½œ</h2>
                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                {% if meeting.status == 'completed' %}
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <a href="{{ url_for('download_file', meeting_id=meeting.id, file_type='speaker_srt') }}" 
                       class="btn btn-success" style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; text-decoration: none; border-radius: var(--radius-md);">
                        <div style="width: 2.5rem; height: 2.5rem; background: rgba(255,255,255,0.2); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center;">
                            <i class="fa fa-users"></i>
                        </div>
                        <div style="flex: 1; text-align: left;">
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">èªè€…æ¨™è¨»å­—å¹•</div>
                            <small style="opacity: 0.8;">åŒ…å«ç™¼è¨€è€…è³‡è¨Šçš„å®Œæ•´å­—å¹•</small>
                        </div>
                    </a>
                    
                    <button class="btn btn-info" onclick="shareResults()" style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; border-radius: var(--radius-md);">
                        <div style="width: 2.5rem; height: 2.5rem; background: rgba(255,255,255,0.2); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center;">
                            <i class="fa fa-share"></i>
                        </div>
                        <div style="flex: 1; text-align: left;">
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">åˆ†äº«çµæœ</div>
                            <small style="opacity: 0.8;">ç”Ÿæˆåˆ†äº«é€£çµæˆ–å°å‡ºå ±å‘Š</small>
                        </div>
                    </button>
                    
                    <button class="btn btn-warning" onclick="editTranscript()" style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; border-radius: var(--radius-md);">
                        <div style="width: 2.5rem; height: 2.5rem; background: rgba(255,255,255,0.2); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center;">
                            <i class="fa fa-edit"></i>
                        </div>
                        <div style="flex: 1; text-align: left;">
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">ç·¨è¼¯å…§å®¹</div>
                            <small style="opacity: 0.8;">ä¿®æ­£è½‰éŒ„å…§å®¹æˆ–èªè€…æ¨™ç±¤</small>
                        </div>
                    </button>
                </div>
                {% elif meeting.status == 'failed' %}
                <div class="alert alert-danger">
                    <h4><i class="fa fa-exclamation-triangle"></i> è™•ç†å¤±æ•—</h4>
                    <p>{{ meeting.error_message if meeting.error_message else 'è™•ç†éç¨‹ä¸­ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤' }}</p>
                    <button class="btn btn-warning" onclick="retryProcessing()">
                        <i class="fa fa-refresh"></i> é‡æ–°è™•ç†
                    </button>
                </div>
                {% elif meeting.status == 'processing' %}
                <div class="alert alert-info">
                    <h4><i class="fa fa-spinner fa-spin"></i> è™•ç†ä¸­</h4>
                    <p>æ‚¨çš„æœƒè­°éŸ³è¨Šæ­£åœ¨è™•ç†ä¸­ï¼Œè™•ç†æ™‚é–“å–æ±ºæ–¼éŸ³è¨Šé•·åº¦ã€‚</p>
                    <div style="background: rgba(255,255,255,0.8); padding: 1rem; border-radius: var(--radius-md); margin-top: 1rem;">
                        <small style="color: var(--text-secondary);">
                            <i class="fa fa-info-circle"></i> 
                            é ä¼°å‰©é¤˜æ™‚é–“ï¼š{{ "%.0f"|format((meeting.duration or 1800)/60 * 0.3) }} åˆ†é˜
                        </small>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        {% if meeting.status == 'completed' and meeting.num_speakers %}
        <!-- èªè€…çµ±è¨ˆ -->
        <div class="x_panel fade-in">
            <div class="x_title">
                <h2><i class="fa fa-chart-pie"></i> èªè€…çµ±è¨ˆ</h2>
                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                <div id="speakerStats">
                    <!-- æ¨¡æ“¬èªè€…çµ±è¨ˆæ•¸æ“š -->
                    {% for i in range(meeting.num_speakers) %}
                    <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: var(--radius-md); margin-bottom: 1rem; border-left: 4px solid var(--primary-color);">
                        <div style="width: 3rem; height: 3rem; background: linear-gradient(135deg, var(--primary-color), var(--primary-light)); border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 1.1rem;">
                            {{ ['A', 'B', 'C', 'D', 'E'][i] }}
                        </div>
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 0.5rem 0; font-size: 1rem; font-weight: 600; color: var(--text-primary);">ç™¼è¨€è€…{{ ['A', 'B', 'C', 'D', 'E'][i] }}</h4>
                            <div style="display: flex; gap: 1rem; font-size: 0.8rem; color: var(--text-secondary);">
                                <span><i class="fa fa-clock"></i> {{ [12.8, 15.2, 10.5, 6.7, 4.8][i] }} åˆ†é˜</span>
                                <span><i class="fa fa-percentage"></i> {{ [28.3, 33.6, 23.2, 14.9, 10.6][i] }}%</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- ç›¸é—œæ“ä½œ -->
        <div class="x_panel fade-in">
            <div class="x_title">
                <h2><i class="fa fa-cogs"></i> æ›´å¤šæ“ä½œ</h2>
                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <button class="btn btn-secondary" onclick="generateReport()" style="justify-content: flex-start;">
                        <i class="fa fa-file-pdf"></i> ç”Ÿæˆæœƒè­°å ±å‘Š
                    </button>
                    <button class="btn btn-secondary" onclick="addToCalendar()" style="justify-content: flex-start;">
                        <i class="fa fa-calendar-plus"></i> åŠ å…¥è¡Œäº‹æ›†
                    </button>
                    <button class="btn btn-secondary" onclick="sendEmail()" style="justify-content: flex-start;">
                        <i class="fa fa-envelope"></i> ç™¼é€éƒµä»¶æ‘˜è¦
                    </button>
                    <hr style="margin: 1rem 0; border-color: var(--border-light);">
                    <button class="btn btn-danger" onclick="deleteRecord()" style="justify-content: flex-start;">
                        <i class="fa fa-trash"></i> åˆªé™¤è¨˜éŒ„
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// è¨­ç½®æœƒè­°IDå’Œç‹€æ…‹ä»¥ä¾›JavaScriptä½¿ç”¨
document.body.dataset.meetingId = "{{ meeting.id }}";
document.body.dataset.meetingStatus = "{{ meeting.status }}";
document.body.dataset.meetingFilename = "{{ meeting.original_filename }}";

// å…¨åŸŸè®Šæ•¸ä¾†å„²å­˜å­—å¹•è³‡æ–™
let subtitleData = null;
let showSpeakers = true;

// è¼‰å…¥çœŸå¯¦å­—å¹•å…§å®¹çš„å‡½æ•¸
function loadSubtitleContent() {
    const subtitlePreview = document.getElementById('subtitlePreview');
    const meetingId = document.body.dataset.meetingId;
    
    if (!meetingId) {
        showSubtitleError('ç„¡æ³•å–å¾—æœƒè­°ID');
        return;
    }
    
    // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹ï¼Œæä¾›è¦–è¦ºåé¥‹çµ¦ç”¨æˆ¶
    showLoadingState();
    
    // é¦–å…ˆå˜—è©¦è¼‰å…¥çµæ§‹åŒ–çš„å­—å¹•è³‡æ–™
    fetch(`/api/meeting/${meetingId}/subtitle/formatted`)
        .then(response => {
            if (!response.ok) {
                // å¦‚æœçµæ§‹åŒ– API å¤±æ•—ï¼Œå˜—è©¦è¼‰å…¥åŸå§‹å­—å¹•å…§å®¹
                console.warn('çµæ§‹åŒ–å­—å¹•è¼‰å…¥å¤±æ•—ï¼Œå˜—è©¦è¼‰å…¥åŸå§‹å…§å®¹');
                return loadRawSubtitleContent(meetingId);
            }
            return response.json();
        })
        .then(data => {
            if (data && data.segments) {
                subtitleData = data.segments;
                displayStructuredSubtitles(data.segments);
                enableAdvancedFeatures();
            } else {
                throw new Error('çµæ§‹åŒ–è³‡æ–™æ ¼å¼éŒ¯èª¤');
            }
        })
        .catch(error => {
            console.error('è¼‰å…¥å­—å¹•å¤±æ•—:', error);
            // å¦‚æœçµæ§‹åŒ–è¼‰å…¥å¤±æ•—ï¼Œå˜—è©¦è¼‰å…¥åŸå§‹å…§å®¹ä½œç‚ºå‚™é¸æ–¹æ¡ˆ
            loadRawSubtitleContent(meetingId);
        });
}

// è¼‰å…¥åŸå§‹å­—å¹•å…§å®¹ä½œç‚ºå‚™é¸æ–¹æ¡ˆ
function loadRawSubtitleContent(meetingId) {
    return fetch(`/api/meeting/${meetingId}/subtitle`)
        .then(response => {
            if (!response.ok) {
                // æ ¹æ“šä¸åŒçš„éŒ¯èª¤ç‹€æ…‹ç¢¼æä¾›å…·é«”çš„éŒ¯èª¤è¨Šæ¯
                switch (response.status) {
                    case 404:
                        throw new Error('å­—å¹•æª”æ¡ˆä¸å­˜åœ¨æˆ–æœƒè­°è¨˜éŒ„ä¸å­˜åœ¨');
                    case 400:
                        throw new Error('æœƒè­°å°šæœªè™•ç†å®Œæˆï¼Œè«‹ç¨å€™å†è©¦');
                    case 500:
                        throw new Error('ä¼ºæœå™¨è™•ç†éŒ¯èª¤ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡');
                    default:
                        throw new Error(`è¼‰å…¥å¤±æ•— (éŒ¯èª¤ä»£ç¢¼: ${response.status})`);
                }
            }
            return response.text();
        })
        .then(rawContent => {
            if (rawContent && rawContent.trim()) {
                displayRawSubtitles(rawContent);
                enableBasicFeatures();
            } else {
                throw new Error('å­—å¹•å…§å®¹ç‚ºç©º');
            }
        })
        .catch(error => {
            console.error('è¼‰å…¥åŸå§‹å­—å¹•å¤±æ•—:', error);
            showSubtitleError(error.message);
        });
}

// é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
function showLoadingState() {
    const subtitlePreview = document.getElementById('subtitlePreview');
    subtitlePreview.innerHTML = `
        <div style="text-align: center; color: var(--text-secondary); padding: 3rem;">
            <div style="margin-bottom: 1.5rem;">
                <i class="fa fa-spinner fa-spin" style="font-size: 3rem; color: var(--primary-color);"></i>
            </div>
            <h4 style="margin-bottom: 0.5rem; color: var(--text-primary);">è¼‰å…¥å­—å¹•å…§å®¹ä¸­</h4>
            <p style="margin: 0; font-size: 0.9rem;">æ­£åœ¨å¾ä¼ºæœå™¨ç²å–è½‰éŒ„çµæœ...</p>
            <div style="margin-top: 1.5rem;">
                <div style="width: 200px; height: 4px; background: var(--bg-accent); border-radius: 2px; margin: 0 auto; overflow: hidden;">
                    <div style="width: 100%; height: 100%; background: linear-gradient(90deg, var(--primary-color), var(--secondary-color)); animation: progressSlide 2s ease-in-out infinite;"></div>
                </div>
            </div>
        </div>
    `;
}

// é¡¯ç¤ºçµæ§‹åŒ–å­—å¹•å…§å®¹
function displayStructuredSubtitles(segments) {
    const subtitlePreview = document.getElementById('subtitlePreview');
    
    if (!segments || segments.length === 0) {
        showSubtitleError('æ²’æœ‰å¯é¡¯ç¤ºçš„å­—å¹•å…§å®¹');
        return;
    }
    
    // å»ºç«‹çµæ§‹åŒ–çš„å­—å¹•é¡¯ç¤º
    let html = '<div class="structured-subtitles">';
    
    segments.forEach((segment, index) => {
        const speakerClass = showSpeakers ? '' : ' style="display: none;"';
        const speakerColor = getSpeakerColor(segment.speaker);
        
        // è¨˜éŒ„æ¯å€‹èªè€…çš„é¡è‰²æ˜ å°„ï¼Œå¹«åŠ©èª¿è©¦
        console.log(`æ®µè½ ${index}: èªè€… "${segment.speaker}" -> é¡è‰²: ${speakerColor}`);
        
        html += `
            <div class="subtitle-segment" data-index="${index}" data-start="${segment.start_time}" data-end="${segment.end_time}" data-speaker="${escapeHtml(segment.speaker)}">
                <div class="segment-header"${speakerClass}>
                    <span class="speaker-tag" style="background: ${speakerColor};" title="èªè€…: ${escapeHtml(segment.speaker)}">
                        ${escapeHtml(segment.speaker)}
                    </span>
                    <span class="timestamp" onclick="seekToTime(${segment.start_time})" title="é»æ“Šè·³è½‰åˆ°æ­¤æ™‚é–“é»">
                        ${escapeHtml(segment.start_time_formatted)} - ${escapeHtml(segment.end_time_formatted)}
                    </span>
                </div>
                <div class="segment-content">
                    ${escapeHtml(segment.content)}
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    subtitlePreview.innerHTML = html;
    
    // æ·»åŠ CSSæ¨£å¼ä¾†ç¾åŒ–é¡¯ç¤º
    addSubtitleStyles();
    
    // è¨˜éŒ„æˆåŠŸé¡¯ç¤ºçš„çµ±è¨ˆä¿¡æ¯
    const speakerCounts = {};
    segments.forEach(segment => {
        speakerCounts[segment.speaker] = (speakerCounts[segment.speaker] || 0) + 1;
    });
    
    console.log('å­—å¹•é¡¯ç¤ºå®Œæˆï¼Œèªè€…çµ±è¨ˆ:', speakerCounts);
}

// é¡¯ç¤ºåŸå§‹å­—å¹•å…§å®¹
function displayRawSubtitles(rawContent) {
    const subtitlePreview = document.getElementById('subtitlePreview');
    
    if (!rawContent || !rawContent.trim()) {
        showSubtitleError('å­—å¹•å…§å®¹ç‚ºç©º');
        return;
    }
    
    // è™•ç†åŸå§‹SRTå…§å®¹ï¼Œæ·»åŠ åŸºæœ¬çš„æ ¼å¼åŒ–
    const formattedContent = formatRawSubtitles(rawContent);
    subtitlePreview.innerHTML = `<div class="raw-subtitles">${formattedContent}</div>`;
    
    // å•Ÿç”¨åŸºæœ¬åŠŸèƒ½
    enableBasicFeatures();
}

// æ ¼å¼åŒ–åŸå§‹å­—å¹•å…§å®¹
function formatRawSubtitles(content) {
    // å°‡ç´”æ–‡å­—å…§å®¹è½‰æ›ç‚ºHTMLï¼Œä¿æŒåŸæœ‰çš„æ›è¡Œå’Œæ ¼å¼
    let formatted = escapeHtml(content).replace(/\n/g, '<br>');
    
    // ç‚ºæ•¸å­—æ ¼å¼çš„èªè€…æ¨™ç±¤æ·»åŠ æ¨£å¼
    const numericSpeakerPatterns = [
        { pattern: /\[ç™¼è¨€è€…(\d+)\]/g, replacement: '<span class="speaker-tag speaker-numeric-$1">[ç™¼è¨€è€…$1]</span>' },
        { pattern: /\[èªè€…(\d+)\]/g, replacement: '<span class="speaker-tag speaker-numeric-$1">[èªè€…$1]</span>' },
        { pattern: /\[Speaker(\d+)\]/g, replacement: '<span class="speaker-tag speaker-numeric-$1">[Speaker$1]</span>' },
        { pattern: /\[SPEAKER_(\d+)\]/g, replacement: '<span class="speaker-tag speaker-numeric-$1">[SPEAKER_$1]</span>' },
    ];
    
    // ç‚ºå­—æ¯æ ¼å¼çš„èªè€…æ¨™ç±¤æ·»åŠ æ¨£å¼ï¼ˆå‘å¾Œç›¸å®¹ï¼‰
    const letterSpeakerPatterns = [
        { pattern: /\[ç™¼è¨€è€…([A-Z])\]/g, replacement: '<span class="speaker-tag speaker-letter-$1">[ç™¼è¨€è€…$1]</span>' },
        { pattern: /\[Speaker ([A-Z])\]/g, replacement: '<span class="speaker-tag speaker-letter-$1">[Speaker $1]</span>' },
        { pattern: /\[èªè€…([A-Z])\]/g, replacement: '<span class="speaker-tag speaker-letter-$1">[èªè€…$1]</span>' },
    ];
    
    // æ‡‰ç”¨æ•¸å­—æ ¼å¼çš„æ¨£å¼
    numericSpeakerPatterns.forEach(({ pattern, replacement }) => {
        formatted = formatted.replace(pattern, replacement);
    });
    
    // æ‡‰ç”¨å­—æ¯æ ¼å¼çš„æ¨£å¼
    letterSpeakerPatterns.forEach(({ pattern, replacement }) => {
        formatted = formatted.replace(pattern, replacement);
    });
    
    return formatted;
}

// é¡¯ç¤ºéŒ¯èª¤ç‹€æ…‹
function showSubtitleError(errorMessage) {
    const subtitlePreview = document.getElementById('subtitlePreview');
    subtitlePreview.innerHTML = `
        <div style="text-align: center; color: var(--danger-color); padding: 3rem;">
            <div style="margin-bottom: 1.5rem;">
                <i class="fa fa-exclamation-triangle" style="font-size: 3rem;"></i>
            </div>
            <h4 style="margin-bottom: 1rem;">è¼‰å…¥å­—å¹•å¤±æ•—</h4>
            <p style="margin-bottom: 2rem; color: var(--text-secondary);">${escapeHtml(errorMessage)}</p>
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button class="btn btn-primary" onclick="loadSubtitleContent()">
                    <i class="fa fa-refresh"></i> é‡æ–°è¼‰å…¥
                </button>
                <button class="btn btn-secondary" onclick="contactSupport()">
                    <i class="fa fa-support"></i> è¯ç¹«æ”¯æ´
                </button>
            </div>
        </div>
    `;
}

// å•Ÿç”¨é€²éšåŠŸèƒ½ï¼ˆç•¶æœ‰çµæ§‹åŒ–è³‡æ–™æ™‚ï¼‰
function enableAdvancedFeatures() {
    console.log('é€²éšå­—å¹•åŠŸèƒ½å·²å•Ÿç”¨');
}

// å•Ÿç”¨åŸºæœ¬åŠŸèƒ½ï¼ˆç•¶åªæœ‰åŸå§‹å…§å®¹æ™‚ï¼‰
function enableBasicFeatures() {
    console.log('åŸºæœ¬å­—å¹•åŠŸèƒ½å·²å•Ÿç”¨');
}

// èªè€…æ¨¡å¼åˆ‡æ›åŠŸèƒ½
function toggleSubtitleMode() {
    const modeText = document.getElementById('modeToggleText');
    const speakerElements = document.querySelectorAll('.speaker-tag, .segment-header');
    
    showSpeakers = !showSpeakers;
    
    speakerElements.forEach(element => {
        if (element.classList.contains('segment-header')) {
            element.style.display = showSpeakers ? 'flex' : 'none';
        } else {
            element.style.display = showSpeakers ? 'inline' : 'none';
        }
    });
    
    modeText.textContent = showSpeakers ? 'éš±è—èªè€…æ¨™ç±¤' : 'é¡¯ç¤ºèªè€…æ¨™ç±¤';
    localStorage.setItem('showSpeakers', showSpeakers.toString());
    
    // è¨˜éŒ„åˆ‡æ›æ“ä½œï¼Œå¹«åŠ©èª¿è©¦
    console.log(`èªè€…æ¨™ç±¤é¡¯ç¤ºæ¨¡å¼åˆ‡æ›ç‚º: ${showSpeakers ? 'é¡¯ç¤º' : 'éš±è—'}`);
}

// è¤‡è£½å­—å¹•æ–‡å­—åŠŸèƒ½
function copySubtitleText() {
    let textToCopy = '';
    
    if (subtitleData && subtitleData.length > 0) {
        textToCopy = subtitleData.map(segment => {
            if (showSpeakers) {
                return `[${segment.speaker}] (${segment.start_time_formatted} - ${segment.end_time_formatted})\n${segment.content}\n`;
            } else {
                return segment.content;
            }
        }).join('\n\n');
    } else {
        const subtitlePreview = document.getElementById('subtitlePreview');
        textToCopy = subtitlePreview.textContent || subtitlePreview.innerText;
    }
    
    navigator.clipboard.writeText(textToCopy).then(() => {
        showNotification('âœ… è½‰éŒ„å…§å®¹å·²è¤‡è£½åˆ°å‰ªè²¼æ¿ï¼', 'success');
    }).catch(error => {
        console.error('è¤‡è£½å¤±æ•—:', error);
        fallbackCopyText(textToCopy);
    });
}

// å‚™é¸è¤‡è£½æ–¹æ³•
function fallbackCopyText(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    document.body.appendChild(textArea);
    textArea.select();
    
    try {
        document.execCommand('copy');
        showNotification('âœ… è½‰éŒ„å…§å®¹å·²è¤‡è£½åˆ°å‰ªè²¼æ¿ï¼', 'success');
    } catch (error) {
        showNotification('âŒ è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸æ“‡æ–‡å­—è¤‡è£½ã€‚', 'error');
    }
    
    document.body.removeChild(textArea);
}

// æœå°‹è½‰éŒ„å…§å®¹åŠŸèƒ½
function searchInTranscript() {
    const searchTerm = prompt('è«‹è¼¸å…¥è¦æœå°‹çš„å…§å®¹ï¼š');
    if (!searchTerm || !searchTerm.trim()) return;
    
    const subtitlePreview = document.getElementById('subtitlePreview');
    const searchRegex = new RegExp(`(${escapeRegex(searchTerm.trim())})`, 'gi');
    let foundCount = 0;
    
    if (subtitleData && subtitleData.length > 0) {
        foundCount = searchInStructuredContent(searchRegex);
    } else {
        foundCount = searchInRawContent(searchRegex);
    }
    
    if (foundCount > 0) {
        showNotification(`âœ… æ‰¾åˆ° ${foundCount} å€‹åŒ¹é…é …ç›®ï¼Œå·²é«˜äº®é¡¯ç¤ºã€‚`, 'success');
        const firstMatch = subtitlePreview.querySelector('mark');
        if (firstMatch) {
            firstMatch.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    } else {
        showNotification('âŒ æœªæ‰¾åˆ°åŒ¹é…çš„å…§å®¹ã€‚', 'error');
    }
}

// åœ¨çµæ§‹åŒ–å…§å®¹ä¸­æœå°‹
function searchInStructuredContent(searchRegex) {
    let foundCount = 0;
    const segments = document.querySelectorAll('.segment-content');
    
    segments.forEach(segment => {
        const originalText = segment.textContent;
        const highlightedText = originalText.replace(searchRegex, (match) => {
            foundCount++;
            return `<mark style="background: #FEF3C7; padding: 2px 4px; border-radius: 3px; font-weight: bold;">${match}</mark>`;
        });
        
        if (highlightedText !== originalText) {
            segment.innerHTML = highlightedText;
        }
    });
    
    return foundCount;
}

// åœ¨åŸå§‹å…§å®¹ä¸­æœå°‹
function searchInRawContent(searchRegex) {
    const subtitlePreview = document.getElementById('subtitlePreview');
    const originalText = subtitlePreview.textContent;
    let foundCount = 0;
    
    const highlightedText = originalText.replace(searchRegex, (match) => {
        foundCount++;
        return `<mark style="background: #FEF3C7; padding: 2px 4px; border-radius: 3px; font-weight: bold;">${match}</mark>`;
    });
    
    if (foundCount > 0) {
        subtitlePreview.innerHTML = highlightedText.replace(/\n/g, '<br>');
    }
    
    return foundCount;
}

// åŒ¯å‡ºè½‰éŒ„å…§å®¹åŠŸèƒ½
function exportTranscript() {
    let content = '';
    const meetingFilename = document.body.dataset.meetingFilename || 'meeting';
    
    if (subtitleData && subtitleData.length > 0) {
        content = generateDetailedExport();
        downloadTextFile(content, `${meetingFilename}_detailed_transcript.txt`);
    } else {
        const subtitlePreview = document.getElementById('subtitlePreview');
        content = subtitlePreview.textContent || subtitlePreview.innerText;
        downloadTextFile(content, `${meetingFilename}_transcript.txt`);
    }
    
    showNotification('âœ… è½‰éŒ„å…§å®¹å·²åŒ¯å‡ºï¼', 'success');
}

// ç”Ÿæˆè©³ç´°çš„åŒ¯å‡ºå…§å®¹
function generateDetailedExport() {
    const meeting = {
        filename: document.body.dataset.meetingFilename || 'æœªçŸ¥æª”æ¡ˆ',
        date: new Date().toLocaleDateString('zh-TW'),
        totalSegments: subtitleData.length,
        totalDuration: subtitleData.length > 0 ? subtitleData[subtitleData.length - 1].end_time : 0
    };
    
    let content = `æœƒè­°è½‰éŒ„å ±å‘Š
=====================================
æª”æ¡ˆåç¨±: ${meeting.filename}
åŒ¯å‡ºæ—¥æœŸ: ${meeting.date}
ç¸½æ®µè½æ•¸: ${meeting.totalSegments}
æœƒè­°æ™‚é•·: ${formatTime(meeting.totalDuration)}

è©³ç´°å…§å®¹:
=====================================

`;
    
    subtitleData.forEach((segment, index) => {
        content += `${index + 1}. [${segment.speaker}] (${segment.start_time_formatted} - ${segment.end_time_formatted})\n`;
        content += `${segment.content}\n\n`;
    });
    
    content += `=====================================
å ±å‘ŠçµæŸ - ç”± AI æœƒè­°åŠ©æ‰‹ç”Ÿæˆ`;
    
    return content;
}

// å·¥å…·å‡½æ•¸
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function escapeRegex(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

// å·¥å…·å‡½æ•¸ï¼šç²å–èªè€…é¡è‰²ï¼ˆæ”¯æ´æ•¸å­—æ ¼å¼çš„èªè€…æ¨™ç±¤ï¼‰
function getSpeakerColor(speaker) {
    // ç‚ºæ•¸å­—æ ¼å¼çš„èªè€…æ¨™ç±¤æä¾›é¡è‰²æ˜ å°„
    const numericColors = {
        'ç™¼è¨€è€…00': 'linear-gradient(135deg, #4F46E5, #6366F1)',
        'ç™¼è¨€è€…01': 'linear-gradient(135deg, #10B981, #047857)',
        'ç™¼è¨€è€…02': 'linear-gradient(135deg, #F59E0B, #D97706)',
        'ç™¼è¨€è€…03': 'linear-gradient(135deg, #EF4444, #DC2626)',
        'ç™¼è¨€è€…04': 'linear-gradient(135deg, #8B5CF6, #7C3AED)',
        'ç™¼è¨€è€…05': 'linear-gradient(135deg, #06B6D4, #0891B2)',
        'ç™¼è¨€è€…06': 'linear-gradient(135deg, #84CC16, #65A30D)',
        'ç™¼è¨€è€…07': 'linear-gradient(135deg, #F97316, #EA580C)',
        'ç™¼è¨€è€…08': 'linear-gradient(135deg, #EC4899, #DB2777)',
        'ç™¼è¨€è€…09': 'linear-gradient(135deg, #6366F1, #4F46E5)',
    };
    
    // å‚³çµ±å­—æ¯æ ¼å¼çš„èªè€…æ¨™ç±¤é¡è‰²æ˜ å°„ï¼ˆå‘å¾Œç›¸å®¹ï¼‰
    const letterColors = {
        'ç™¼è¨€è€…A': 'linear-gradient(135deg, #4F46E5, #6366F1)',
        'ç™¼è¨€è€…B': 'linear-gradient(135deg, #10B981, #047857)',
        'ç™¼è¨€è€…C': 'linear-gradient(135deg, #F59E0B, #D97706)',
        'ç™¼è¨€è€…D': 'linear-gradient(135deg, #EF4444, #DC2626)',
        'ç™¼è¨€è€…E': 'linear-gradient(135deg, #8B5CF6, #7C3AED)',
    };
    
    // é¦–å…ˆæª¢æŸ¥æ•¸å­—æ ¼å¼
    if (numericColors[speaker]) {
        return numericColors[speaker];
    }
    
    // ç„¶å¾Œæª¢æŸ¥å­—æ¯æ ¼å¼
    if (letterColors[speaker]) {
        return letterColors[speaker];
    }
    
    // å¦‚æœéƒ½æ²’æœ‰åŒ¹é…ï¼Œå˜—è©¦å¾èªè€…åç¨±ä¸­æå–æ•¸å­—æˆ–å­—æ¯
    const numericMatch = speaker.match(/(\d+)/);
    if (numericMatch) {
        const number = parseInt(numericMatch[1]);
        const colorIndex = number % 10; // ä½¿ç”¨æ¨¡é‹ç®—ä¾†å¾ªç’°ä½¿ç”¨é¡è‰²
        const colorArray = Object.values(numericColors);
        return colorArray[colorIndex];
    }
    
    const letterMatch = speaker.match(/([A-Z])/);
    if (letterMatch) {
        const letter = letterMatch[1];
        const colorIndex = letter.charCodeAt(0) - 65; // A=0, B=1, C=2...
        const colorArray = Object.values(letterColors);
        return colorArray[colorIndex % colorArray.length];
    }
    
    // é è¨­é¡è‰²ï¼ˆç”¨æ–¼æœªçŸ¥æˆ–ç„¡æ³•è­˜åˆ¥çš„èªè€…ï¼‰
    return 'linear-gradient(135deg, #6B7280, #4B5563)';
}

function seekToTime(seconds) {
    console.log(`è·³è½‰åˆ°æ™‚é–“: ${seconds} ç§’`);
    showNotification(`ğŸ“ æ™‚é–“æˆ³è¨˜: ${formatTime(seconds)}`, 'info');
}

function formatTime(seconds) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = Math.floor(seconds % 60);
    
    if (hours > 0) {
        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    } else {
        return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }
}

function downloadTextFile(content, filename) {
    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.style.display = 'none';
    
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// å­—å¹•æ¨£å¼
function addSubtitleStyles() {
    // æª¢æŸ¥æ˜¯å¦å·²ç¶“æ·»åŠ éæ¨£å¼ï¼Œé¿å…é‡è¤‡æ·»åŠ é€ æˆæ¨£å¼è¡çª
    if (document.getElementById('subtitle-styles')) return;
    
    const style = document.createElement('style');
    style.id = 'subtitle-styles';
    
    style.textContent = `
        /* å­—å¹•å®¹å™¨çš„åŸºç¤æ¨£å¼ */
        .structured-subtitles {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            /* ä½¿ç”¨ç­‰å¯¬å­—é«”ç¢ºä¿æ™‚é–“æˆ³è¨˜å°é½Š */
            width: 100%; /* è¨­å®šå¯¬åº¦èˆ‡çˆ¶å®¹å™¨ç›¸åŒ */
            overflow-y: auto; /* å•Ÿç”¨å‚ç›´æ»¾å‹• */
            overflow-x: auto; /* é˜²æ­¢é•·å¥å­å°è‡´æ°´å¹³æ»¾å‹•å•é¡Œ */
        }
        
        /* å€‹åˆ¥å­—å¹•æ®µè½çš„ç·Šæ¹ŠåŒ–è¨­è¨ˆ */
        .subtitle-segment {
            display: inline-flex;
            
            padding: 0.4rem 0.6rem;
            
            /* é€™å€‹å°é–“è·è¶³ä»¥å€åˆ†ä¸åŒæ®µè½ï¼Œä½†ä¸æœƒé€ æˆéåº¦åˆ†é›¢ */
            margin-bottom: 0.1rem;
            
            border-radius: var(--radius-md);
            transition: background-color 0.2s ease, border-left-color 0.2s ease;
            border-left: 3px solid transparent;
            
            /* æ–°å¢ï¼šç¢ºä¿é«˜åº¦å®Œå…¨ç”±å…§å®¹æ±ºå®šï¼Œä¸è¨­ç½®æœ€å°é«˜åº¦ */
            min-height: unset;
            
            /* æ–°å¢ï¼šæ§åˆ¶å…§éƒ¨å…ƒç´ ä¸ç”¢ç”Ÿé¡å¤–çš„å¤–é‚Šè· */
            overflow: hidden;
        }
        
        /* æ‡¸åœæ•ˆæœä¿æŒä¸è®Šï¼Œä½†éæ¸¡æ›´åŠ æµæš¢ */
        .subtitle-segment:hover {
            background-color: var(--bg-hover);
            border-left-color: var(--primary-color);
            /* è¼•å¾®çš„é™°å½±æ•ˆæœå¢å¼·äº’å‹•åé¥‹ */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        /* èªè€…ä¿¡æ¯å€åŸŸçš„ç·Šæ¹ŠåŒ–è¨­è¨ˆ */
        .segment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            
            margin-bottom: 0.4rem;
            
            font-size: 0.75rem; /* ç¨å¾®ç¸®å°å­—é«”ï¼Œç¯€çœå‚ç›´ç©ºé–“ */
            
            /* æ–°å¢ï¼šæ§åˆ¶è¡Œé«˜ï¼Œç¢ºä¿ç·Šæ¹Šé¡¯ç¤º */
            line-height: 1.5;
            
            /* æ–°å¢ï¼šé˜²æ­¢å…§å®¹æ›è¡Œé€ æˆä¸å¿…è¦çš„é«˜åº¦å¢åŠ  */
            white-space: nowrap;
            
            /* æ–°å¢ï¼šç¢ºä¿ä¸æœƒæœ‰é¡å¤–çš„å¤–é‚Šè· */
            margin-top: 0;

            margin-bottom: 0.25rem;
        }
        
        /* èªè€…æ¨™ç±¤çš„ç²¾ç´°èª¿æ•´ */
        .speaker-tag {
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-sm);
            color: white;
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            flex-shrink: 0;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* æ™‚é–“æˆ³è¨˜çš„å„ªåŒ–è¨­è¨ˆ */
        .timestamp {
            color: var(--text-light);
            font-family: monospace;
            cursor: pointer;
            transition: color 0.2s ease;
            
            /* æ–°å¢ï¼šç¢ºä¿æ™‚é–“æˆ³è¨˜ä¸æœƒè¢«å£“ç¸® */
            flex-shrink: 0;
            
            /* æ–°å¢ï¼šçµ±ä¸€çš„å­—é«”å¤§å°ç¢ºä¿æ•´é½Šå°é½Š */
            font-size: 0.8rem;
            
            /* æ–°å¢ï¼šè¼•å¾®çš„èƒŒæ™¯è‰²å¢å¼·å¯è®€æ€§ */
            background: rgba(0, 0, 0, 0.05);
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
        }
        
        .timestamp:hover {
            color: var(--primary-color);
            text-decoration: underline;
            /* æ–°å¢ï¼šæ‡¸åœæ™‚çš„èƒŒæ™¯è‰²è®ŠåŒ– */
            background: rgba(79, 70, 229, 0.1);
        }
        
        /* å…§å®¹æ–‡å­—å€åŸŸçš„ç·Šæ¹ŠåŒ– */
        .segment-content {
            color: var(--text-primary);
            
            line-height: 1.35;
            
            font-size: 0.85rem;
            
            /* æ–°å¢ï¼šç¢ºä¿æ²’æœ‰ä»»ä½•é¡å¤–çš„é‚Šè·å’Œå…§é‚Šè· */
            margin: 0;
            padding: 0;
            
            /* æ–°å¢ï¼šå„ªåŒ–æ–‡å­—æ¸²æŸ“ï¼Œæå‡åœ¨å°å­—é«”ä¸‹çš„æ¸…æ™°åº¦ */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            
            /* æ–°å¢ï¼šç¢ºä¿é•·å–®è©ä¸æœƒæ’ç ´å®¹å™¨ */
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        /* åŸå§‹å­—å¹•å…§å®¹çš„æ¨£å¼èª¿æ•´ */
        .raw-subtitles {
            line-height: 1.5; /* å¾ 1.8 é™åˆ° 1.5 */
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            font-size: 0.9rem; /* ç¨å¾®ç¸®å°å­—é«” */
            
            /* æ–°å¢ï¼šæ”¹å–„åŸå§‹å­—å¹•çš„é–“è· */
            padding: 0.5rem;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
        }
        
        /* è¼‰å…¥å‹•ç•«ä¿æŒåŸæœ‰çš„æµæš¢æ•ˆæœ */
        @keyframes progressSlide {
            0% { transform: translateX(-100%); }
            50% { transform: translateX(0%); }
            100% { transform: translateX(100%); }
        }
        
        /* æœå°‹é«˜äº®æ•ˆæœçš„å„ªåŒ– */
        mark {
            /* ä½¿ç”¨æ›´æŸ”å’Œçš„é«˜äº®æ•ˆæœï¼Œé¿å…è¦–è¦ºå¹²æ“¾ */
            background: linear-gradient(120deg, #FEF3C7 0%, #FCD34D 100%);
            padding: 1px 3px; /* å¾ 2px 4px ç¸®æ¸› */
            border-radius: 2px;
            font-weight: 500; /* æ¸›å°‘å­—é‡ï¼Œé¿å…éæ–¼çªå‡º */
            animation: highlightPulse 1s ease-in-out;
        }
        
        @keyframes highlightPulse {
            0% { background: linear-gradient(120deg, #FEF3C7 0%, #FCD34D 100%); }
            50% { background: linear-gradient(120deg, #FCD34D 0%, #F59E0B 100%); }
            100% { background: linear-gradient(120deg, #FEF3C7 0%, #FCD34D 100%); }
        }
        

        
        /* æ–°å¢ï¼šå°åˆ·æ¨£å¼çš„å„ªåŒ– */
        @media print {
            .subtitle-segment {
                padding: 0.3rem 0.5rem;
                margin-bottom: 0.2rem;
                border: 1px solid #ccc;
                break-inside: avoid; /* é¿å…æ®µè½è¢«åˆ†é åˆ‡æ–· */
            }
            
            .timestamp {
                background: transparent !important;
                color: #666 !important;
            }
            
            .speaker-tag {
                background: #f0f0f0 !important;
                color: #333 !important;
            }
        }
        
        /* æ–°å¢ï¼šè¼”åŠ©åŠŸèƒ½å„ªåŒ– */
        @media (prefers-reduced-motion: reduce) {
            /* ç‚ºæœ‰å‹•ä½œæ•æ„Ÿæ€§çš„ç”¨æˆ¶é—œé–‰å‹•ç•« */
            .subtitle-segment,
            .timestamp,
            mark {
                transition: none !important;
                animation: none !important;
            }
        }
        
    `;
    
    // å°‡æ¨£å¼æ·»åŠ åˆ°é é¢é ­éƒ¨
    document.head.appendChild(style);
    
}

function contactSupport() {
    const supportInfo = `
å¦‚æœæ‚¨é‡åˆ°å•é¡Œï¼Œè«‹æä¾›ä»¥ä¸‹è³‡è¨Šï¼š

â€¢ æœƒè­°ID: ${document.body.dataset.meetingId}
â€¢ ç€è¦½å™¨: ${navigator.userAgent}
â€¢ æ™‚é–“: ${new Date().toISOString()}
â€¢ éŒ¯èª¤æè¿°: å­—å¹•è¼‰å…¥å¤±æ•—
    `;
    
    if (confirm('æ˜¯å¦è¦è¤‡è£½æ”¯æ´è³‡è¨Šåˆ°å‰ªè²¼æ¿ï¼Ÿ')) {
        navigator.clipboard.writeText(supportInfo).then(() => {
            showNotification('âœ… æ”¯æ´è³‡è¨Šå·²è¤‡è£½ï¼Œè«‹è¯ç¹«æŠ€è¡“æ”¯æ´åœ˜éšŠ', 'info');
        });
    }
}

// ç‹€æ…‹æª¢æŸ¥åŠŸèƒ½
function startStatusCheck() {
    const meetingId = document.body.dataset.meetingId;
    
    const checkStatus = () => {
        fetch(`/api/meeting/${meetingId}/status`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'completed' || data.status === 'failed') {
                    console.log(`ç‹€æ…‹æ”¹è®Šç‚º ${data.status}ï¼Œé‡æ–°è¼‰å…¥é é¢`);
                    location.reload();
                }
            })
            .catch(error => {
                console.error('ç‹€æ…‹æª¢æŸ¥å¤±æ•—:', error);
                if (window.statusCheckFailCount) {
                    window.statusCheckFailCount++;
                } else {
                    window.statusCheckFailCount = 1;
                }
                
                if (window.statusCheckFailCount >= 3) {
                    clearInterval(window.statusInterval);
                    console.log('ç‹€æ…‹æª¢æŸ¥é€£çºŒå¤±æ•—ï¼Œå·²åœæ­¢æª¢æŸ¥');
                }
            });
    };
    
    window.statusInterval = setInterval(checkStatus, 5000);
    
    window.addEventListener('beforeunload', () => {
        if (window.statusInterval) {
            clearInterval(window.statusInterval);
        }
    });
}

// å…¶ä»–åŠŸèƒ½ä¿æŒä¸è®Š
function shareResults() {
    const shareData = {
        title: '{{ meeting.original_filename }} - æœƒè­°è¨˜éŒ„',
        text: 'æŸ¥çœ‹é€™å€‹æœƒè­°çš„AIè½‰éŒ„çµæœå’Œæ‘˜è¦',
        url: window.location.href
    };
    
    if (navigator.share) {
        navigator.share(shareData);
    } else {
        navigator.clipboard.writeText(window.location.href).then(() => {
            showNotification('âœ… åˆ†äº«é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼æ¿ï¼', 'success');
        });
    }
}

function editTranscript() {
    showNotification('ğŸ“ ç·¨è¼¯åŠŸèƒ½é–‹ç™¼ä¸­ï¼Œæ•¬è«‹æœŸå¾…...', 'info');
}

function retryProcessing() {
    if (confirm('ç¢ºå®šè¦é‡æ–°è™•ç†é€™å€‹æœƒè­°éŸ³è¨Šå—ï¼Ÿ')) {
        const meetingId = document.body.dataset.meetingId;
        showNotification('ğŸ”„ å·²é–‹å§‹é‡æ–°è™•ç†ï¼Œè«‹ç¨å€™...', 'info');
        setTimeout(() => {
            location.reload();
        }, 2000);
    }
}

function generateReport() {
    showNotification('ğŸ“Š æ­£åœ¨ç”ŸæˆPDFå ±å‘Š...', 'info');
    setTimeout(() => {
        showNotification('âœ… æœƒè­°å ±å‘Šå·²ç”Ÿæˆä¸¦ä¸‹è¼‰ï¼', 'success');
    }, 2000);
}

function addToCalendar() {
    showNotification('ğŸ“… è¡Œäº‹æ›†åŠŸèƒ½é–‹ç™¼ä¸­...', 'info');
}

function sendEmail() {
    const email = prompt('è«‹è¼¸å…¥è¦ç™¼é€æ‘˜è¦çš„éƒµä»¶åœ°å€ï¼š');
    if (email && email.includes('@')) {
        showNotification(`ğŸ“§ æœƒè­°æ‘˜è¦å·²ç™¼é€è‡³ ${email}`, 'success');
    }
}

function deleteRecord() {
    if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹æœƒè­°è¨˜éŒ„å—ï¼Ÿé€™å€‹æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
        showNotification('ğŸ—‘ï¸ æ­£åœ¨åˆªé™¤è¨˜éŒ„...', 'info');
        setTimeout(() => {
            window.location.href = "{{ url_for('meetings_list') }}";
        }, 1000);
    }
}

function showNotification(message, type = 'info') {
    const alertClass = type === 'success' ? 'alert-success' : 
                      type === 'error' ? 'alert-danger' : 'alert-info';
    
    const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade in" role="alert" style="position: fixed; top: 80px; right: 20px; z-index: 9999; min-width: 300px;">
            <button type="button" class="close" data-dismiss="alert">
                <span aria-hidden="true">Ã—</span>
            </button>
            ${message}
        </div>
    `;
    
    $('body').append(alertHtml);
    
    setTimeout(() => {
        $('.alert').fadeOut();
    }, 3000);
}

// åˆå§‹åŒ–å‡½æ•¸
function initializeMeetingDetail() {
    const meetingId = document.body.dataset.meetingId;
    const meetingStatus = document.body.dataset.meetingStatus;
    
    console.log(`åˆå§‹åŒ–æœƒè­°è©³æƒ…é é¢ - ID: ${meetingId}, ç‹€æ…‹: ${meetingStatus}`);
    
    if (meetingStatus === "processing") {
        startStatusCheck();
    }
    
    if (meetingStatus === "completed") {
        loadSubtitleContent();
    }
    
    // æ¢å¾©ç”¨æˆ¶åå¥½è¨­å®š
    const savedShowSpeakers = localStorage.getItem('showSpeakers');
    if (savedShowSpeakers !== null) {
        showSpeakers = savedShowSpeakers === 'true';
        const modeText = document.getElementById('modeToggleText');
        if (modeText) {
            modeText.textContent = showSpeakers ? 'éš±è—èªè€…æ¨™ç±¤' : 'é¡¯ç¤ºèªè€…æ¨™ç±¤';
        }
    }
    
    // é é¢è¼‰å…¥å‹•ç•«
    const elements = document.querySelectorAll('.fade-in');
    elements.forEach((el, index) => {
        el.style.animationDelay = `${index * 0.1}s`;
    });
}

// é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', initializeMeetingDetail);
</script>
{% endblock %}